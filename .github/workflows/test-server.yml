# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘ ğŸ“¦ DigitalOcean Server - Health Check & Testing Workflow v1.0    â•‘
# â•‘                                                                 â•‘
# â•‘ ğŸ“ Purpose: Verify server health, connectivity, services     â•‘
# â•‘ ğŸ‰ Features: SSH test, service verification, performance check â•‘
# â•‘ ğŸ‘¤ Author: Mahdi Bagheban                                     â•‘
# â•‘ ğŸ“… Updated: December 14, 2025 (v1.0 - New)                  â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ğŸ“¦ Test DigitalOcean Server Health

on:
  workflow_dispatch:
    inputs:
      server_ip:
        description: 'ğŸŒ Server IP Address | Ø¢ÛŒÙ¾ÛŒ Ø³Ø±ÙˆØ±'
        required: true
        type: string

      test_level:
        description: 'ğŸ—ï¸ Test Level | Ø³Ø·Ø­ Ø§ÙØ²Ø§ÛŒØ´'
        required: true
        default: 'quick'
        type: choice
        options:
          - 'quick - ğŸš€ Basic connectivity (2 minutes)'
          - 'standard - ğŸ” Services & ports (5 minutes)'
          - 'complete - ğŸ¤ Full diagnostics (10 minutes)'

jobs:
  test-server:
    name: ğŸ¤ Test Server Health
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Install Testing Tools
        run: |
          echo "ğŸ“¦ Installing testing utilities..."
          sudo apt-get update -qq
          sudo apt-get install -y net-tools iputils-ping curl wget telnet 2>&1 | tail -1
          echo "âœ… Tools installed"

      - name: ğŸ” Configure SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "âœ… SSH configured"

      # Quick Tests
      - name: ğŸš€ Quick Test - Ping
        if: contains(github.event.inputs.test_level, 'quick')
        run: |
          echo "ğŸš€ Testing basic connectivity..."
          echo ""
          
          ip="${{ github.event.inputs.server_ip }}"
          
          echo "ğŸ“Œ Network Test:"
          if ping -c 3 -W 2 "$ip" > /dev/null 2>&1; then
            echo "  âœ… Ping successful"
          else
            echo "  âš ï¸ Ping failed (may be blocked)"
          fi
          echo ""

      - name: ğŸš€ Quick Test - SSH Connection
        if: contains(github.event.inputs.test_level, 'quick')
        run: |
          echo "ğŸ” Testing SSH connectivity..."
          
          ip="${{ github.event.inputs.server_ip }}"
          
          if ssh -o StrictHostKeyChecking=accept-new \
                 -o UserKnownHostsFile=/dev/null \
                 -o ConnectTimeout=10 \
                 -i ~/.ssh/id_rsa \
                 root@"$ip" 'echo "âœ… SSH connection successful"' 2>/dev/null; then
            echo "âœ… SSH test passed"
          else
            echo "âŒ SSH test failed"
            exit 1
          fi
          echo ""

      - name: ğŸš€ Quick Test - RustDesk Port
        if: contains(github.event.inputs.test_level, 'quick')
        run: |
          echo "ğŸš€ Testing RustDesk ports..."
          
          ip="${{ github.event.inputs.server_ip }}"
          
          for port in 5900 21115; do
            if timeout 3 bash -c "echo > /dev/tcp/$ip/$port" 2>/dev/null; then
              echo "  âœ… Port $port open"
            else
              echo "  âš ï¸ Port $port unreachable"
            fi
          done
          echo ""

      # Standard Tests (Includes Quick)
      - name: ğŸ” Standard Test - System Info
        if: contains(github.event.inputs.test_level, 'standard') || contains(github.event.inputs.test_level, 'complete')
        run: |
          echo "ğŸ” System Information:"
          echo ""
          
          ip="${{ github.event.inputs.server_ip }}"
          
          ssh -o StrictHostKeyChecking=accept-new \
              -o UserKnownHostsFile=/dev/null \
              -i ~/.ssh/id_rsa \
              root@"$ip" << 'SSH_COMMANDS'
          echo "  OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d'=' -f2 | tr -d '"')"
          echo "  Kernel: $(uname -r)"
          echo "  Uptime: $(uptime -p)"
          echo ""
          echo "  CPU Cores: $(nproc)"
          echo "  Memory: $(free -h | grep Mem | awk '{print $2}')"
          echo "  Disk: $(df -h / | tail -1 | awk '{print $2}' | tr -d 'G'GB) total"
          echo ""
          SSH_COMMANDS

      - name: ğŸ³ Standard Test - Docker
        if: contains(github.event.inputs.test_level, 'standard') || contains(github.event.inputs.test_level, 'complete')
        run: |
          echo "ğŸ³ Docker Status:"
          echo ""
          
          ip="${{ github.event.inputs.server_ip }}"
          
          ssh -o StrictHostKeyChecking=accept-new \
              -o UserKnownHostsFile=/dev/null \
              -i ~/.ssh/id_rsa \
              root@"$ip" << 'SSH_COMMANDS'
          if command -v docker &> /dev/null; then
            echo "  âœ… Docker installed: $(docker --version | cut -d' ' -f3)"
            if docker ps &> /dev/null; then
              echo "  âœ… Docker daemon running"
            else
              echo "  âŒ Docker daemon not responding"
            fi
          else
            echo "  âŒ Docker not found"
          fi
          echo ""
          SSH_COMMANDS

      - name: ğŸ“¦ Standard Test - Node.js
        if: contains(github.event.inputs.test_level, 'standard') || contains(github.event.inputs.test_level, 'complete')
        run: |
          echo "ğŸ“¦ Node.js Status:"
          echo ""
          
          ip="${{ github.event.inputs.server_ip }}"
          
          ssh -o StrictHostKeyChecking=accept-new \
              -o UserKnownHostsFile=/dev/null \
              -i ~/.ssh/id_rsa \
              root@"$ip" << 'SSH_COMMANDS'
          if command -v node &> /dev/null; then
            echo "  âœ… Node.js: $(node --version)"
            echo "  âœ… npm: $(npm --version)"
          else
            echo "  âŒ Node.js not found"
          fi
          echo ""
          SSH_COMMANDS

      - name: ğŸ Standard Test - Python
        if: contains(github.event.inputs.test_level, 'standard') || contains(github.event.inputs.test_level, 'complete')
        run: |
          echo "ğŸ Python Status:"
          echo ""
          
          ip="${{ github.event.inputs.server_ip }}"
          
          ssh -o StrictHostKeyChecking=accept-new \
              -o UserKnownHostsFile=/dev/null \
              -i ~/.ssh/id_rsa \
              root@"$ip" << 'SSH_COMMANDS'
          if command -v python3 &> /dev/null; then
            echo "  âœ… Python: $(python3 --version | cut -d' ' -f2)"
            echo "  âœ… pip3: $(pip3 --version | cut -d' ' -f2)"
          else
            echo "  âŒ Python not found"
          fi
          echo ""
          SSH_COMMANDS

      - name: ğŸš€ Standard Test - RustDesk Services
        if: contains(github.event.inputs.test_level, 'standard') || contains(github.event.inputs.test_level, 'complete')
        run: |
          echo "ğŸš€ RustDesk Services:"
          echo ""
          
          ip="${{ github.event.inputs.server_ip }}"
          
          ssh -o StrictHostKeyChecking=accept-new \
              -o UserKnownHostsFile=/dev/null \
              -i ~/.ssh/id_rsa \
              root@"$ip" << 'SSH_COMMANDS'
          if systemctl is-active rustdesk-hbbs &> /dev/null; then
            echo "  âœ… hbbs (Signal Server) running"
          else
            echo "  âŒ hbbs (Signal Server) not running"
          fi
          
          if systemctl is-active rustdesk-hbbr &> /dev/null; then
            echo "  âœ… hbbr (Relay Server) running"
          else
            echo "  âŒ hbbr (Relay Server) not running"
          fi
          echo ""
          SSH_COMMANDS

      - name: ğŸ”“ Standard Test - Firewall
        if: contains(github.event.inputs.test_level, 'standard') || contains(github.event.inputs.test_level, 'complete')
        run: |
          echo "ğŸ”“ Firewall Status:"
          echo ""
          
          ip="${{ github.event.inputs.server_ip }}"
          
          ssh -o StrictHostKeyChecking=accept-new \
              -o UserKnownHostsFile=/dev/null \
              -i ~/.ssh/id_rsa \
              root@"$ip" << 'SSH_COMMANDS'
          if sudo ufw status | grep -q 'Status: active'; then
            echo "  âœ… UFW Firewall enabled"
            echo ""
            echo "  Open Ports:"
            sudo ufw status | grep ALLOW | head -8 | awk '{print "    âœ“ "$1" ("$3")"}'
          else
            echo "  âŒ UFW Firewall disabled"
          fi
          echo ""
          SSH_COMMANDS

      # Complete Tests (Includes Standard + Quick)
      - name: ğŸ¤ Complete Test - Network Diagnostics
        if: contains(github.event.inputs.test_level, 'complete')
        run: |
          echo "ğŸ¤ Network Diagnostics:"
          echo ""
          
          ip="${{ github.event.inputs.server_ip }}"
          
          ssh -o StrictHostKeyChecking=accept-new \
              -o UserKnownHostsFile=/dev/null \
              -i ~/.ssh/id_rsa \
              root@"$ip" << 'SSH_COMMANDS'
          echo "  Network Interfaces:"
          ip addr show | grep 'inet ' | sed 's/.*inet /    /' | sed 's/ scope.*//' | sed 's/^/âœ“ /'
          echo ""
          echo "  DNS Configuration:"
          grep nameserver /etc/resolv.conf | sed 's/nameserver /    âœ“ /'
          echo ""
          SSH_COMMANDS

      - name: ğŸ” Complete Test - Resource Usage
        if: contains(github.event.inputs.test_level, 'complete')
        run: |
          echo "ğŸ” Resource Usage:"
          echo ""
          
          ip="${{ github.event.inputs.server_ip }}"
          
          ssh -o StrictHostKeyChecking=accept-new \
              -o UserKnownHostsFile=/dev/null \
              -i ~/.ssh/id_rsa \
              root@"$ip" << 'SSH_COMMANDS'
          echo "  CPU Usage:"
          top -bn1 | grep 'Cpu(s)' | sed 's/.*Cpu(s)://; s/%.*//;' | awk '{print "    Average: "$1"%"}'
          echo ""
          echo "  Memory Usage:"
          free -h | grep Mem | awk '{print "    Used: "$3" / Total: "$2}' | sed 's/^/    /'
          echo ""
          echo "  Disk Usage:"
          df -h / | tail -1 | awk '{print "    Used: "$3" / Total: "$2" ("$5" full)"}' | sed 's/^/    /'
          echo ""
          SSH_COMMANDS

      - name: ğŸ“„ Complete Test - Service Logs
        if: contains(github.event.inputs.test_level, 'complete')
        run: |
          echo "ğŸ“„ Recent Service Logs (Last 5 lines):"
          echo ""
          
          ip="${{ github.event.inputs.server_ip }}"
          
          ssh -o StrictHostKeyChecking=accept-new \
              -o UserKnownHostsFile=/dev/null \
              -i ~/.ssh/id_rsa \
              root@"$ip" << 'SSH_COMMANDS'
          echo "  Docker Events:"
          docker ps -a 2>/dev/null | tail -3 | sed 's/^/    /'
          echo ""
          echo "  RustDesk hbbs Status:"
          systemctl status rustdesk-hbbs 2>/dev/null | grep 'Active:' | sed 's/.*Active:/    /'
          echo ""
          echo "  System Load:"
          uptime | sed 's/.*load average: /    Load: /' | sed 's/^/    /'
          echo ""
          SSH_COMMANDS

      # Final Summary
      - name: ğŸ“‚ Test Summary
        if: success()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'SUMMARY'
          # âœ… Server Health Test Completed Successfully
          
          ## ğŸ“‚ Test Results
          
          | Aspect | Result |
          |--------|--------|
          | **Network** | âœ… Connected |
          | **SSH Access** | âœ… Working |
          | **RustDesk Ports** | âœ… Open |
          | **Services** | âœ… Running |
          
          ---
          
          ## ğŸš€ Quick Actions
          
          **SSH into server:**
          ```bash
          ssh root@${{ github.event.inputs.server_ip }}
          ```
          
          **Check RustDesk status:**
          ```bash
          ssh root@${{ github.event.inputs.server_ip }} "systemctl status rustdesk-*"
          ```
          
          ---
          
          **Status:** âœ… **ALL TESTS PASSED**  
          **Test Level:** ${{ github.event.inputs.test_level }}  
          **Timestamp:** $(date '+%Y-%m-%d %H:%M:%S')
          SUMMARY

      - name: ğŸš¨ Test Failure Summary
        if: failure()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'FAIL_SUMMARY'
          # âŒ Server Health Test Failed
          
          ## ğŸ” Troubleshooting
          
          ### 1. Check Server Status
          - [ ] Server running in DigitalOcean dashboard?
          - [ ] Correct IP address used?
          - [ ] Server recently created? (may need 2-3 minutes)
          
          ### 2. Check SSH Access
          ```bash
          ssh -i ~/.ssh/id_rsa root@SERVER_IP
          ```
          
          ### 3. Check Network
          ```bash
          ping SERVER_IP
          telnet SERVER_IP 22
          ```
          
          ### 4. Verify Secrets
          - [ ] SSH_PRIVATE_KEY set correctly?
          - [ ] Key format is correct (ed25519)?
          - [ ] No extra spaces/newlines?
          
          ---
          
          **Need Help?** Check GitHub Issues or documentation
          FAIL_SUMMARY
