# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘ ðŸ§ª DigitalOcean Workflow Management v2.0                        â•‘
# â•‘                                                                            â•‘
# â•‘ ðŸ“ Purpose: Maintain and optimize workflow setup                       â•‘
# â•‘ ðŸŽ‰ Features: Smart cleanup, backups, detailed reporting              â•‘
# â•‘ ðŸ‘¤ Author: Mahdi Bagheban                                                  â•‘
# â•‘ ðŸ“… Updated: December 2025 (v2.0 - IMPROVEMENTS)                     â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ðŸ§ª Workflow Management

on:
  workflow_dispatch:
    inputs:
      operation:
        description: 'ðŸ“ Operation to perform | Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡ÙŠØ¯'
        required: true
        default: 'status'
        type: choice
        options:
          - 'status - Show workflow status only'
          - 'cleanup - Remove deprecated workflows (requires confirmation)'
          - 'backup - Create backup of all workflows'

      confirm:
        description: 'âš ï¸ Type "yes" to confirm cleanup | Ø¨Ø±Ø§ÛŒ ØªØ§Ø¦ÙŠØ¯ Ø±ÙˆØ´Û "yes" ØªØ§ÙŠÙ¾ ÙƒÙ†ÙŠØ¯'
        required: false
        default: 'no'
        type: choice
        options:
          - 'no'
          - 'yes'

jobs:
  manage:
    name: ðŸ§ª Manage Workflows
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âœ… Verify Operation
        id: verify
        run: |
          operation="${{ github.event.inputs.operation }}"
          operation_type=$(echo "$operation" | cut -d' ' -f1)
          echo "operation_type=$operation_type" >> $GITHUB_OUTPUT
          echo "ðŸ“ Operation selected: $operation_type"

      - name: ðŸ“‹ Show Workflow Status
        if: steps.verify.outputs.operation_type == 'status'
        run: |
          echo "ðŸ“‹ Current Workflow Status:"
          echo ""
          echo "âœ… ACTIVE WORKFLOWS:"
          if [ -d ".github/workflows" ]; then
            ls -1 .github/workflows/*.yml 2>/dev/null | while read file; do
              filename=$(basename "$file")
              size=$(wc -c < "$file")
              lines=$(wc -l < "$file")
              echo "  âœ… $filename ($lines lines, $size bytes)"
            done
          else
            echo "  No workflows found"
          fi
          echo ""
          echo "ðŸ“‹ Total workflows: $(ls -1 .github/workflows/*.yml 2>/dev/null | wc -l)"
          echo ""
          echo "ðŸ“ Last updated: $(git log -1 --format=%ai -- .github/workflows/ 2>/dev/null || echo 'N/A')"

      - name: ðŸ“„ Create Backup
        if: steps.verify.outputs.operation_type == 'backup' || steps.verify.outputs.operation_type == 'cleanup'
        id: backup
        run: |
          echo "ðŸ“„ Creating backup of all workflows..."
          mkdir -p /tmp/workflow-backup
          
          if [ -d ".github/workflows" ]; then
            cp -r .github/workflows/* /tmp/workflow-backup/ 2>/dev/null || true
            backup_count=$(ls -1 /tmp/workflow-backup/*.yml 2>/dev/null | wc -l)
            echo "backup_count=$backup_count" >> $GITHUB_OUTPUT
            echo "âœ… Backup created: $backup_count files"
            
            # Create tar archive
            tar -czf /tmp/workflow-backup.tar.gz -C /tmp workflow-backup/
            backup_size=$(du -h /tmp/workflow-backup.tar.gz | cut -f1)
            echo "backup_size=$backup_size" >> $GITHUB_OUTPUT
            echo "âœ… Archive: workflow-backup.tar.gz ($backup_size)"
          else
            echo "âš ï¸ No workflows directory found"
          fi

      - name: âš ï¸ Confirm Cleanup
        if: steps.verify.outputs.operation_type == 'cleanup' && github.event.inputs.confirm != 'yes'
        run: |
          echo "âŒ Cleanup cancelled."
          echo "ðŸ” To proceed with cleanup, you must:"
          echo "  1. Set operation to: cleanup - Remove deprecated workflows (requires confirmation)"
          echo "  2. Set confirm to: yes"
          exit 1

      - name: ðŸ—‘ï¸ Clean Old Files
        if: steps.verify.outputs.operation_type == 'cleanup' && github.event.inputs.confirm == 'yes'
        run: |
          echo "ðŸ—‘ï¸ Starting cleanup process..."
          echo ""
          
          # Define files to keep
          declare -a KEEP_FILES=(
            "create-server.yml"
            "delete-server.yml"
            "cleanup-old-workflows.yml"
          )
          
          removed_count=0
          
          if [ -d ".github/workflows" ]; then
            for file in .github/workflows/*.yml; do
              filename=$(basename "$file")
              
              # Check if file should be kept
              should_keep=false
              for keep_file in "${KEEP_FILES[@]}"; do
                if [ "$filename" = "$keep_file" ]; then
                  should_keep=true
                  break
                fi
              done
              
              if [ "$should_keep" = true ]; then
                echo "  âœ… KEEP: $filename"
              else
                echo "  ðŸ—‘ï¸ REMOVE: $filename"
                rm -f "$file"
                ((removed_count++))
              fi
            done
          fi
          
          echo ""
          echo "âœ… Cleanup complete: $removed_count files removed"

      - name: ðŸ“‹ Cleanup Summary
        if: steps.verify.outputs.operation_type == 'cleanup' && github.event.inputs.confirm == 'yes'
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸ§ª Workflow Cleanup Completed!
          
          ## âœ… Preserved Workflows
          | Workflow | Purpose | Status |
          |----------|---------|--------|
          | `create-server.yml` | Create DigitalOcean server with RustDesk | âœ… Active |
          | `delete-server.yml` | Safe server deletion | âœ… Active |
          | `cleanup-old-workflows.yml` | Workflow management | âœ… Active |
          
          ## ðŸ—‘ï¸ Removed
          - Old deprecated workflow files
          - Test workflows
          - Unused configurations
          
          ## ðŸ“„ Backup Status
          - Backup location: `/tmp/workflow-backup/`
          - Archive: `workflow-backup.tar.gz`
          - Can be restored if needed
          
          ## ðŸŽ‰ Current Setup
          
          ### Create Server Workflow Features
          - âœ… Ubuntu 24.04 LTS
          - âœ… Docker & Docker Compose
          - âœ… RustDesk Server OSS (Self-hosted)
          - âœ… Node.js (Latest LTS)
          - âœ… Python 3 with pip
          - âœ… UFW Firewall configured
          - âœ… Auto QR code generation
          - âœ… Connection guides
          
          ### Delete Server Workflow Features
          - âœ… Safe deletion with confirmation
          - âœ… API retry logic (3 attempts)
          - âœ… Clear error messages
          - âœ… Optimized verification (45s)
          
          ## ðŸš€ Next Steps
          1. Go to **GitHub Actions**
          2. Select **ðŸš€ Create DigitalOcean Server with RustDesk**
          3. Fill in server details
          4. Click **Run workflow**
          
          ---
          
          **Cleaned:** $(date)
          **Status:** âœ… **COMPLETED**
          EOF

      - name: ðŸ’» Show Setup Info
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "              ðŸš€ YOUR OPTIMIZED WORKFLOW SETUP ðŸš€"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“¦ INSTALLED COMPONENTS:"
          echo "  âœ… Docker & Docker Compose"
          echo "  âœ… RustDesk Server OSS (Self-Hosted)"
          echo "  âœ… Node.js (Latest LTS)"
          echo "  âœ… Python 3 with pip"
          echo "  âœ… Git & Essential Dev Tools"
          echo "  âœ… UFW Firewall (IPv4 + IPv6)"
          echo "  âœ… QR Code Generator"
          echo ""
          echo "ðŸ”¥ SECURITY:"
          echo "  âœ… Automatic SSH key setup"
          echo "  âœ… Firewall configured with essential ports"
          echo "  âœ… Double confirmation for deletion"
          echo "  âœ… API retry logic for reliability"
          echo ""
          echo "ðŸ’µ COST OPTIMIZATION:"
          echo "  âœ… Lightweight footprint"
          echo "  âœ… Nano plan: $4/month"
          echo "  âœ… Small plan: $26/month"
          echo "  âœ… Standard plan: $52/month"
          echo ""
          echo "ðŸŒ AVAILABLE REGIONS:"
          echo "  âœ… Frankfurt (Recommended for Iran)"
          echo "  âœ… Amsterdam, London, New York, San Francisco, Singapore"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
