# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘           ðŸ—‘ï¸ DigitalOcean Server Deletion Workflow v5.2               â•‘
# â•‘                                                                           â•‘
# â•‘  ðŸ“ Purpose:  Ø­Ø°Ù Ø§Ù…Ù† Ùˆ Ú©Ù†ØªØ±Ù„â€ŒØ´Ø¯Ù‡ Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ DigitalOcean              â•‘
# â•‘  ðŸŒŸ Version:  5.2 (Production Ready)                                  â•‘
# â•‘  ðŸ‘¤ Author:   Mahdi Bagheban                                           â•‘
# â•‘  ðŸ“… Date:     December 2025                                            â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ðŸ—‘ï¸ Delete DigitalOcean Server

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'âš ï¸ Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ Ø­Ø°ÙØŒ "yes" ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯ | Type "yes" to confirm'
        required: true
        default: 'no'
        type: choice
        options:
          - 'no'
          - 'yes'

      server_name:
        description: 'ðŸ“› Ù†Ø§Ù… Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù | Server name to delete'
        required: true
        default: 'mahdi-dev-workspace'
        type: string

jobs:
  delete:
    name: ðŸ—‘ï¸ Delete Server
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: âš ï¸ Confirmation Check
        if: github.event.inputs.confirm != 'yes'
        run: |
          echo "âŒ Ø­Ø°Ù Ù„ØºÙˆ Ø´Ø¯. Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù Ø¨Ø§ÛŒØ¯ Ù…Ù‚Ø¯Ø§Ø± confirm Ø±Ø§ 'yes' ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯."
          exit 1

      - name: ðŸ”§ Install Tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq curl 2>&1 | tail -1

      - name: ðŸ” Validate Secret
        run: |
          if [ -z "${{ secrets.DO_API_TOKEN }}" ]; then
            echo "âŒ DO_API_TOKEN ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª"
            exit 1
          fi
          echo "âœ… DO_API_TOKEN Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª"

      - name: ðŸ” Find Droplet
        id: find
        env:
          DO_API_TOKEN: ${{ secrets.DO_API_TOKEN }}
          TARGET_NAME: ${{ github.event.inputs.server_name }}
        run: |
          echo "ðŸ”Ž Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³Ø±ÙˆØ± Ø¨Ø§ Ù†Ø§Ù…: $TARGET_NAME"
          
          data=$(curl -s -H "Authorization: Bearer $DO_API_TOKEN" \
            "https://api.digitalocean.com/v2/droplets")
          
          droplet_id=$(echo "$data" | jq -r ".droplets[] | select(.name==\"$TARGET_NAME\") | .id" | head -1)
          
          if [ -z "$droplet_id" ] || [ "$droplet_id" = "null" ]; then
            echo "âŒ Ù‡ÛŒÚ† Ø³Ø±ÙˆØ±ÛŒ Ø¨Ø§ Ù†Ø§Ù… '$TARGET_NAME' ÛŒØ§ÙØª Ù†Ø´Ø¯"
            echo "ðŸ“‹ Ù„ÛŒØ³Øª Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯:"
            echo "$data" | jq -r '.droplets[] | "  â€¢ \(.name) (ID: \(.id))"'
            exit 1
          fi
          
          ip=$(echo "$data" | jq -r ".droplets[] | select(.id==$droplet_id) | .networks.v4[] | select(.type==\"public\") | .ip_address" | head -1)
          size=$(echo "$data" | jq -r ".droplets[] | select(.id==$droplet_id) | .size_slug")
          region=$(echo "$data" | jq -r ".droplets[] | select(.id==$droplet_id) | .region.slug")
          created=$(echo "$data" | jq -r ".droplets[] | select(.id==$droplet_id) | .created_at")
          
          echo "droplet_id=$droplet_id" >> $GITHUB_OUTPUT
          echo "ip=$ip" >> $GITHUB_OUTPUT
          echo "size=$size" >> $GITHUB_OUTPUT
          echo "region=$region" >> $GITHUB_OUTPUT
          echo "created=$created" >> $GITHUB_OUTPUT
          
          echo "âœ… Ø³Ø±ÙˆØ± ÛŒØ§ÙØª Ø´Ø¯: ID=$droplet_id, IP=$ip"

      - name: ðŸ—‘ï¸ Delete Droplet
        id: delete
        env:
          DO_API_TOKEN: ${{ secrets.DO_API_TOKEN }}
        run: |
          id="${{ steps.find.outputs.droplet_id }}"
          echo "ðŸ—‘ï¸ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø°Ù Droplet Ø¨Ø§ ID: $id"
          
          code=$(curl -s -o /tmp/resp.json -w "%{http_code}" -X DELETE \
            -H "Authorization: Bearer $DO_API_TOKEN" \
            "https://api.digitalocean.com/v2/droplets/$id")
          
          if [ "$code" = "204" ]; then
            echo "âœ… Ø³Ø±ÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯"
          else
            echo "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù (HTTP $code)"
            cat /tmp/resp.json
            exit 1
          fi

      - name: ðŸ“‹ Success Summary
        if: success()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # âœ… Ø³Ø±ÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯
          
          ## ðŸ“› Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³Ø±ÙˆØ± Ø­Ø°Ùâ€ŒØ´Ø¯Ù‡
          
          | Ù…ÙˆØ±Ø¯ | Ù…Ù‚Ø¯Ø§Ø± |
          |------|-------|
          | ðŸ“ Ù†Ø§Ù… Ø³Ø±ÙˆØ± | `${{ github.event.inputs.server_name }}` |
          | ðŸ†” Droplet ID | `${{ steps.find.outputs.droplet_id }}` |
          | ðŸŒ Ù…Ù†Ø·Ù‚Ù‡ | `${{ steps.find.outputs.region }}` |
          | ðŸ’» Ù¾Ù„Ù† | `${{ steps.find.outputs.size }}` |
          | ðŸŒ IP | `${{ steps.find.outputs.ip }}` |
          | ðŸ“† ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯ | `${{ steps.find.outputs.created }}` |
          
          ## ðŸ’° Ù‡Ø²ÛŒÙ†Ù‡
          
          - ðŸ’³ Ø§Ø² Ø§ÛŒÙ† Ù„Ø­Ø¸Ù‡ Ø¨Ù‡ Ø¨Ø¹Ø¯ Ù‡Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø³Ø±ÙˆØ± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯
          - ðŸ“Š Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù‡Ø²ÛŒÙ†Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø±Ø§ Ø¯Ø± Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ DigitalOcean Ø¨Ø¨ÛŒÙ†ÛŒØ¯
          
          ## ðŸ” Ù…Ø±Ø§Ø­Ù„ Ø¨Ø¹Ø¯ÛŒ
          
          - Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø² Workflow Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø±ÙˆØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
          - Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… Ù†ÛŒØ§Ø²ØŒ Volumes ÛŒØ§ Snapshots Ø§Ø¶Ø§ÙÛŒ Ø±Ø§ Ù†ÛŒØ² Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯
          
          ---
          ðŸŽ‰ **Ø¹Ù…Ù„ÛŒØ§Øª Ø­Ø°Ù Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.**
          EOF

      - name: âŒ Failure Summary
        if: failure()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # âŒ Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø³Ø±ÙˆØ±
          
          Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ø¹Ù…Ù„ÛŒØ§Øª Ø­Ø°Ù Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯.
          
          ## ðŸ” Ù…ÙˆØ§Ø±Ø¯ÛŒ Ú©Ù‡ Ø¨Ø§ÛŒØ¯ Ø¨Ø±Ø±Ø³ÛŒ Ø´ÙˆÙ†Ø¯
          
          1. Ø¢ÛŒØ§ Ù†Ø§Ù… Ø³Ø±ÙˆØ± Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯ØŸ
          2. Ø¢ÛŒØ§ DO_API_TOKEN Ù…Ø¹ØªØ¨Ø± Ø§Ø³ØªØŸ
          3. Ø¢ÛŒØ§ Ø³Ø±ÙˆØ± Ù‚Ø¨Ù„Ø§Ù‹ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ Ø­Ø°Ù Ù†Ø´Ø¯Ù‡ Ø§Ø³ØªØŸ
          
          ## ðŸ› ï¸ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ù‡Ø§
          
          - Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Job Ø±Ø§ Ø¨Ø§ Ø¯Ù‚Øª Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯
          - Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø³Ø±ÙˆØ± Ø±Ø§ Ø§Ø² Ù¾Ù†Ù„ DigitalOcean Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ Ø­Ø°Ù Ú©Ù†ÛŒØ¯
          
          ---
          Ø¨Ø±Ø§ÛŒ Ú©Ù…Ú© Ø¨ÛŒØ´ØªØ± Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯Ø± Ø¨Ø®Ø´ Issues Ø§ÛŒÙ† Ø±ÛŒÙ¾Ùˆ Ø³ÙˆØ§Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ù…Ø·Ø±Ø­ Ú©Ù†ÛŒØ¯.
          EOF
