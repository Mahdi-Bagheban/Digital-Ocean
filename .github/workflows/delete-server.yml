name: ðŸ—‘ï¸ Delete Development Server

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'âš ï¸ Type "yes" to confirm deletion (Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ "yes" ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯)'
        required: true
        default: 'no'
        type: choice
        options:
          - 'no'
          - 'yes'
      server_name:
        description: 'ðŸ“› Server name to delete (Ù†Ø§Ù… Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù)'
        required: false
        default: 'dev-server'

jobs:
  delete-server:
    runs-on: ubuntu-latest
    
    steps:
      - name: âš¡ Confirmation Check
        if: github.event.inputs.confirm != 'yes'
        run: |
          echo "âŒ Deletion cancelled. You must select 'yes' to confirm."
          exit 1
      
      - name: ðŸ”§ Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
      
      - name: ðŸ” Find and Delete Server
        env:
          DO_API_TOKEN: ${{ secrets.DO_API_TOKEN }}
          SERVER_NAME: ${{ github.event.inputs.server_name }}
        run: |
          echo "ðŸ”Ž Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³Ø±ÙˆØ± Ø¨Ø§ Ù†Ø§Ù…: $SERVER_NAME"
          
          # Get all droplets
          response=$(curl -s -X GET \
            -H "Authorization: Bearer $DO_API_TOKEN" \
            -H "Content-Type: application/json" \
            "https://api.digitalocean.com/v2/droplets")
          
          # Find droplet ID by name
          droplet_id=$(echo "$response" | jq -r ".droplets[] | select(.name == \"$SERVER_NAME\") | .id")
          
          if [ -z "$droplet_id" ] || [ "$droplet_id" == "null" ]; then
            echo "âŒ Ø³Ø±ÙˆØ± Ø¨Ø§ Ù†Ø§Ù… '$SERVER_NAME' ÛŒØ§ÙØª Ù†Ø´Ø¯"
            echo "::warning::No server found with name '$SERVER_NAME'"
            
            echo "ðŸ“‹ Ù„ÛŒØ³Øª Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯:"
            echo "$response" | jq -r '.droplets[] | "  - \(.name) (ID: \(.id))"'
            
            exit 1
          fi
          
          echo "âœ… Ø³Ø±ÙˆØ± ÛŒØ§ÙØª Ø´Ø¯!"
          echo "ðŸ†” Droplet ID: $droplet_id"
          
          # Get server info before deletion
          server_info=$(echo "$response" | jq -r ".droplets[] | select(.id == $droplet_id)")
          server_ip=$(echo "$server_info" | jq -r '.networks.v4[0].ip_address // "N/A"')
          server_region=$(echo "$server_info" | jq -r '.region.name // "N/A"')
          server_size=$(echo "$server_info" | jq -r '.size_slug // "N/A"')
          server_created=$(echo "$server_info" | jq -r '.created_at // "N/A"')
          
          echo "ðŸ“Š Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³Ø±ÙˆØ± Ù‚Ø¨Ù„ Ø§Ø² Ø­Ø°Ù:"
          echo "  - Ù†Ø§Ù…: $SERVER_NAME"
          echo "  - IP: $server_ip"
          echo "  - Ù…Ù†Ø·Ù‚Ù‡: $server_region"
          echo "  - Ø§Ù†Ø¯Ø§Ø²Ù‡: $server_size"
          echo "  - ØªØ§Ø±ÛŒØ® Ø³Ø§Ø®Øª: $server_created"
          
          # Save to outputs
          echo "droplet_id=$droplet_id" >> $GITHUB_OUTPUT
          echo "server_ip=$server_ip" >> $GITHUB_OUTPUT
          echo "server_region=$server_region" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ðŸ—‘ï¸ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø°Ù Ø³Ø±ÙˆØ±..."
          
          # Delete droplet
          http_code=$(curl -s -o /tmp/delete_response.json -w "%{http_code}" -X DELETE \
            -H "Authorization: Bearer $DO_API_TOKEN" \
            -H "Content-Type: application/json" \
            "https://api.digitalocean.com/v2/droplets/$droplet_id")
          
          if [ "$http_code" == "204" ]; then
            echo "âœ… Ø³Ø±ÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯!"
            echo "ðŸ†” Droplet ID: $droplet_id Ø­Ø°Ù Ø´Ø¯"
          else
            echo "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø³Ø±ÙˆØ±!"
            echo "HTTP Status Code: $http_code"
            cat /tmp/delete_response.json
            exit 1
          fi
      
      - name: ðŸ“Š Success Summary
        if: success()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## âœ… Ø³Ø±ÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯
          
          ### ðŸ—‘ï¸ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³Ø±ÙˆØ± Ø­Ø°Ù Ø´Ø¯Ù‡
          
          | Ù…ÙˆØ±Ø¯ | Ù…Ù‚Ø¯Ø§Ø± |
          |------|-------|
          | ðŸ“› Ù†Ø§Ù… Ø³Ø±ÙˆØ± | ${{ github.event.inputs.server_name }} |
          | ðŸ†” Droplet ID | Ø­Ø°Ù Ø´Ø¯ |
          | ðŸŒ Ù…Ù†Ø·Ù‚Ù‡ | DigitalOcean |
          
          ### ðŸ’° Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
          
          Ø³Ø±ÙˆØ± Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø² DigitalOcean Ø­Ø°Ù Ø´Ø¯ Ùˆ Ø¯ÛŒÚ¯Ø± Ù‡Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø®ÙˆØ§Ù‡ÛŒØ¯ Ú©Ø±Ø¯.
          
          ðŸ’³ **Ù‡Ø²ÛŒÙ†Ù‡ Ù†Ù‡Ø§ÛŒÛŒ** Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
          
          ### ðŸ“Œ Ù…Ø±Ø§Ø­Ù„ Ø¨Ø¹Ø¯ÛŒ
          
          - âœ… Ø³Ø±ÙˆØ± Ø­Ø°Ù Ø´Ø¯ Ùˆ Ø¯ÛŒÚ¯Ø± ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª
          - ðŸ’µ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ø¯Ø± Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ DigitalOcean Ù‚Ø§Ø¨Ù„ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø§Ø³Øª
          - ðŸ”„ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ø³Ø±ÙˆØ± Ø¬Ø¯ÛŒØ¯ Ø§Ø² workflow "Create Development Server" Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
          
          ---
          
          ðŸŽ‰ **Ø¹Ù…Ù„ÛŒØ§Øª Ø­Ø°Ù Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯!**
          EOF
      
      - name: ðŸ“Š Failure Summary
        if: failure()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## âŒ Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø³Ø±ÙˆØ±
          
          Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ø¹Ù…Ù„ÛŒØ§Øª Ø­Ø°Ù Ø³Ø±ÙˆØ± Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯.
          
          ### ðŸ” Ø¨Ø±Ø±Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ:
          
          1. âœ… Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø³Ø±ÙˆØ±ÛŒ Ø¨Ø§ Ù†Ø§Ù… Ù…Ø´Ø®Øµ Ø´Ø¯Ù‡ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
          2. âœ… Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯ Ú©Ù‡ API Token Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª
          3. âœ… Ù„ÛŒØ³Øª Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ù„Ø§Ú¯ Ø¨Ø§Ù„Ø§ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†ÛŒØ¯
          
          ### ðŸ› ï¸ Ø±Ø§Ù‡â€ŒØ­Ù„â€ŒÙ‡Ø§:
          
          - Ù„ÛŒØ³Øª Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø± Ù„Ø§Ú¯ Ø¨Ø§Ù„Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª
          - Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø§ Ù†Ø§Ù… ØµØ­ÛŒØ­ Ø³Ø±ÙˆØ±ØŒ workflow Ø±Ø§ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯
          - ÛŒØ§ Ø§Ø² Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ DigitalOcean Ø³Ø±ÙˆØ± Ø±Ø§ Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø¯Ø³ØªÛŒ Ø­Ø°Ù Ú©Ù†ÛŒØ¯
          
          EOF
