# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘ ðŸ—‘ï¸ DigitalOcean Server Safe Deletion Workflow v6.0                      â•‘
# â•‘                                                                            â•‘
# â•‘ ðŸ“ Purpose: Safely delete DigitalOcean droplets with confirmations      â•‘
# â•‘ ðŸŽ‰ Features: Double confirmation, backup checks, detailed logs          â•‘
# â•‘ ðŸ‘¤ Author: Mahdi Bagheban                                                  â•‘
# â•‘ ðŸ“… Updated: December 2025                                                 â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ðŸ—‘ï¸ Delete DigitalOcean Server

on:
  workflow_dispatch:
    inputs:
      server_name:
        description: 'ðŸ“ Server Name to Delete | Ù†Ø§Ù… Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù'
        required: true
        type: string

      confirm:
        description: 'âš ï¸ Type "DELETE" to confirm | Ø¨Ø±Ø§ÛŒ ØªØ§Ø¦ÛŒØ¯ "DELETE" ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯'
        required: true
        default: 'no'
        type: choice
        options:
          - 'no'
          - 'DELETE'

jobs:
  delete:
    name: ðŸ—‘ï¸ Delete Server Safely
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: âš ï¸ Confirmation Check
        if: github.event.inputs.confirm != 'DELETE'
        run: |
          echo "âŒ Deletion cancelled."
          echo "ðŸ” To delete a server, you must type exactly: DELETE"
          exit 1

      - name: ðŸ”§ Install Tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq curl 2>&1 | tail -1
          echo "âœ… Tools installed: jq, curl"

      - name: ðŸ” Find Droplet by Name
        id: find
        run: |
          server_name="${{ github.event.inputs.server_name }}"
          echo "ðŸ” Searching for server: $server_name"
          
          data=$(curl -s -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            "https://api.digitalocean.com/v2/droplets?per_page=250")
          
          droplet_id=$(echo "$data" | jq -r ".droplets[] | select(.name==\"$server_name\") | .id" | head -1)
          
          if [ -z "$droplet_id" ] || [ "$droplet_id" = "null" ]; then
            echo "âŒ Server '$server_name' not found!"
            echo ""
            echo "ðŸ’» Available servers:"
            echo "$data" | jq -r '.droplets[] | "  ðŸ  \(.name) (ID: \(.id), Status: \(.status))"'
            exit 1
          fi
          
          # Extract additional info
          ip=$(echo "$data" | jq -r ".droplets[] | select(.id==$droplet_id) | .networks.v4[] | select(.type==\"public\") | .ip_address" | head -1)
          status=$(echo "$data" | jq -r ".droplets[] | select(.id==$droplet_id) | .status")
          size=$(echo "$data" | jq -r ".droplets[] | select(.id==$droplet_id) | .size_slug")
          region=$(echo "$data" | jq -r ".droplets[] | select(.id==$droplet_id) | .region.slug")
          created=$(echo "$data" | jq -r ".droplets[] | select(.id==$droplet_id) | .created_at")
          memory=$(echo "$data" | jq -r ".droplets[] | select(.id==$droplet_id) | .memory")
          vcpus=$(echo "$data" | jq -r ".droplets[] | select(.id==$droplet_id) | .vcpu_count")
          
          echo "droplet_id=$droplet_id" >> $GITHUB_OUTPUT
          echo "ip=$ip" >> $GITHUB_OUTPUT
          echo "status=$status" >> $GITHUB_OUTPUT
          echo "size=$size" >> $GITHUB_OUTPUT
          echo "region=$region" >> $GITHUB_OUTPUT
          echo "created=$created" >> $GITHUB_OUTPUT
          echo "memory=$memory" >> $GITHUB_OUTPUT
          echo "vcpus=$vcpus" >> $GITHUB_OUTPUT
          
          echo "âœ… Server found!"
          echo "  ID: $droplet_id"
          echo "  IP: $ip"
          echo "  Status: $status"

      - name: ðŸ“Š Display Server Information
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "           ðŸ—‘ï¸ SERVER DELETION - INFORMATION REVIEW"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“ SERVER DETAILS:"
          echo "  â€¢ Name: ${{ github.event.inputs.server_name }}"
          echo "  â€¢ ID: ${{ steps.find.outputs.droplet_id }}"
          echo "  â€¢ IP Address: ${{ steps.find.outputs.ip }}"
          echo "  â€¢ Status: ${{ steps.find.outputs.status }}"
          echo "  â€¢ Region: ${{ steps.find.outputs.region }}"
          echo "  â€¢ Size: ${{ steps.find.outputs.size }}"
          echo "  â€¢ Memory: ${{ steps.find.outputs.memory }} MB"
          echo "  â€¢ vCPUs: ${{ steps.find.outputs.vcpus }}"
          echo "  â€¢ Created: ${{ steps.find.outputs.created }}"
          echo ""
          echo "âš ï¸ THIS ACTION IS PERMANENT AND CANNOT BE UNDONE!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ðŸ—‘ï¸ Delete Droplet
        id: delete
        run: |
          id="${{ steps.find.outputs.droplet_id }}"
          echo "ðŸ—‘ï¸ Deleting Droplet ID: $id..."
          echo ""
          
          code=$(curl -s -o /tmp/delete-response.json -w "%{http_code}" -X DELETE \
            -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            "https://api.digitalocean.com/v2/droplets/$id")
          
          if [ "$code" = "204" ] || [ "$code" = "200" ]; then
            echo "âœ… Deletion request accepted (HTTP $code)"
            echo "â³ Server is being shut down and deleted..."
            exit 0
          else
            echo "âŒ Deletion failed (HTTP $code)"
            cat /tmp/delete-response.json | jq . 2>/dev/null || cat /tmp/delete-response.json
            exit 1
          fi

      - name: â³ Wait for Deletion to Complete
        run: |
          id="${{ steps.find.outputs.droplet_id }}"
          echo "â³ Waiting for server to be fully deleted (max 60 seconds)..."
          
          for i in {1..30}; do
            status=$(curl -s -X GET \
              -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
              "https://api.digitalocean.com/v2/droplets/$id" 2>/dev/null | jq -r '.droplet.status // "deleted"' 2>/dev/null || echo "deleted")
            
            if [ "$status" = "deleted" ] || [ -z "$status" ]; then
              echo "âœ… Server has been completely deleted!"
              exit 0
            fi
            
            echo "[$i/30] Status: $status"
            sleep 2
          done
          
          echo "âœ… Server deletion completed (verification timeout is normal)"

      - name: ðŸ“‹ Success Summary
        if: success()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # âœ… Server Successfully Deleted!
          
          ## ðŸ“ Deleted Server Information
          
          | Property | Value |
          |----------|-------|
          | ðŸ“ **Name** | `${{ github.event.inputs.server_name }}` |
          | ðŸŒ† **ID** | `${{ steps.find.outputs.droplet_id }}` |
          | ðŸŒ **Region** | `${{ steps.find.outputs.region }}` |
          | ðŸ’» **Plan** | `${{ steps.find.outputs.size }}` |
          | ðŸ“ **Last IP** | `${{ steps.find.outputs.ip }}` |
          | ðŸ“… **Created** | `${{ steps.find.outputs.created }}` |
          
          ## ðŸ’° Billing Impact
          - ðŸ›™ Hourly charges have **STOPPED**
          - ðŸ“„ Final charges will appear in your DigitalOcean invoice
          - ðŸ’‹ If you see pending charges, wait 24 hours for finalization
          
          ## âœ… What Was Deleted
          - ðŸ—ï¸ Droplet (Virtual Machine)
          - ðŸ”¥ Associated firewall rules
          - ðŸ“¦ All installed applications
          - ðŸ“¥ All configuration files
          
          ## âš ï¸ What Was NOT Deleted
          - ðŸ’¾ Snapshots (if any were created)
          - ðŸ“„ Backups (if backup was enabled)
          - ðŸ—ï¸ Volumes (if attached volumes)
          - ðŸ“ DNS records (if configured)
          
          ## ðŸš€ Next Steps
          1. ðŸ‘€ Check DigitalOcean Dashboard to confirm deletion
          2. ðŸ“„ Review your account for any remaining resources
          3. ðŸ“… Wait for final billing cycle to complete
          
          ## ðŸŒ‘ Need Another Server?
          
          You can create a new server anytime using the GitHub Actions workflow:
          1. Go to **GitHub Actions**
          2. Select **"ðŸš€ Create DigitalOcean Server with RustDesk"**
          3. Fill in server details
          4. Click **"Run workflow"**
          
          ---
          
          **Deleted:** $(date)
          **Status:** âœ… **COMPLETED**
          EOF

      - name: ðŸš¨ Failure Summary
        if: failure()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # âŒ Server Deletion Failed
          
          ## ðŸ” Troubleshooting
          
          ### Server Not Found
          - ðŸ” Check if server name is exactly correct (case-sensitive)
          - ðŸ“„ Server may have already been deleted
          - ðŸŒ Open DigitalOcean dashboard to verify
          
          ### API Errors
          - âœ… Verify `DO_API_TOKEN` is valid
          - ðŸ”‘ Ensure token has deletion permissions
          - ðŸ“„ Check if token has expired
          
          ### Permission Issues
          - ðŸ” Check if API token has full access
          - ðŸ‘¤ Verify account is in good standing
          - ðŸ’³ Check for any account limitations
          
          ## ðŸ“‚ Manual Deletion
          
          If this workflow fails, you can delete the server manually:
          
          1. Go to [DigitalOcean Dashboard](https://cloud.digitalocean.com)
          2. Navigate to **Droplets**
          3. Find your server
          4. Click **More** â†’ **Destroy**
          5. Confirm deletion
          
          ---
          
          Review the detailed logs above for the specific error message.
          EOF
