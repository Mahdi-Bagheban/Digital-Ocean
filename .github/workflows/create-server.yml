name: ğŸš€ Create Development Server with KASM

on:
  workflow_dispatch:
    inputs:
      server_name:
        description: 'ğŸ’» Server Name (Ù†Ø§Ù… Ø³Ø±ÙˆØ±)'
        required: false
        default: 'mahdi-dev-workspace'
      region:
        description: 'ğŸ—ºï¸ Datacenter Region (Ù…Ù†Ø·Ù‚Ù‡ Ø¯ÛŒØªØ§Ø³Ù†ØªØ±)'
        required: false
        default: 'fra1'
        type: choice
        options:
          - fra1  # Frankfurt (ÙØ±Ø§Ù†Ú©ÙÙˆØ±Øª)
          - ams3  # Amsterdam (Ø¢Ù…Ø³ØªØ±Ø¯Ø§Ù…)
          - lon1  # London (Ù„Ù†Ø¯Ù†)
          - nyc1  # New York (Ù†ÛŒÙˆÛŒÙˆØ±Ú©)

jobs:
  create-server:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # âœ… Timeout Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² hanging
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ”§ Install Dependencies
        run: |
          set -e  # Ø®Ø±ÙˆØ¬ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§
          echo "Installing system dependencies..."
          sudo apt-get update
          sudo apt-get install -y jq bc curl wget
          echo "âœ“ Dependencies installed"
          
          # Ø¨Ø±Ø±Ø³ÛŒ Ù†ØµØ¨ Ø¨ÙˆØ¯Ù† Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§
          echo "Verifying installations..."
          jq --version
          bc --version
          curl --version
      
      - name: ğŸ” Validate Secrets
        run: |
          if [ -z "${{ secrets.DO_API_TOKEN }}" ]; then
            echo "âŒ DO_API_TOKEN is not set"
            echo "Please go to: Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          fi
          
          if [ -z "${{ secrets.SSH_KEY_NAME }}" ]; then
            echo "âŒ SSH_KEY_NAME is not set"
            echo "Please go to: Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          fi
          
          echo "âœ“ All secrets are configured"
      
      - name: ğŸ” Configure Environment
        run: |
          cat > .env << 'EOF'
DO_API_TOKEN=${{ secrets.DO_API_TOKEN }}
SSH_KEY_NAME=${{ secrets.SSH_KEY_NAME }}
DROPLET_NAME=${{ github.event.inputs.server_name }}
REGION=${{ github.event.inputs.region }}
EOF
          
          # Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„ .env
          if [ ! -f ".env" ]; then
            echo "âŒ Failed to create .env file"
            exit 1
          fi
          
          echo "âœ“ Environment configured"
          # Ù†Ù…Ø§ÛŒØ´ ØªÙ†Ø¸ÛŒÙ…Ø§Øª (Ø¨Ø¯ÙˆÙ† token)
          echo "Configuration:"
          grep -v DO_API_TOKEN .env
      
      - name: ğŸš€ Create Server
        id: create_server
        run: |
          set -e
          
          echo "Starting server creation..."
          
          # Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª
          if [ ! -f "create-server.sh" ]; then
            echo "âŒ create-server.sh not found"
            exit 1
          fi
          
          # Ø¯Ø§Ø¯Ù† Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¬Ø±Ø§ÛŒÛŒ
          chmod +x create-server.sh
          
          # Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ø§ error handling
          if ./create-server.sh; then
            echo "âœ“ Server creation completed successfully"
          else
            echo "âŒ Server creation failed"
            exit 1
          fi
      
      - name: ğŸ“¤ Save Server Information
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: server-info
          path: |
            .droplet_id
            .droplet_ip
            .droplet_created_at
          retention-days: 7
          if-no-files-found: warn
      
      - name: ğŸ“Š Success Summary Report
        if: success()
        run: |
          {
            echo "## ğŸ‰ Ø³Ø±ÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯!"
            echo ""
            echo "### ğŸ“‹ Server Information:"
            echo ""
            echo "| Ù…ÙˆØ±Ø¯ | Ù…Ù‚Ø¯Ø§Ø± |"
            echo "|------|-------|"
            echo "| **Server ID** | \`$(cat .droplet_id)\` |"
            echo "| **Server IP** | \`$(cat .droplet_ip)\` |"
            echo "| **Server Name** | ${{ github.event.inputs.server_name }} |"
            echo "| **Region** | ${{ github.event.inputs.region }} |"
            echo "| **Specs** | 32GB RAM â€¢ 2 vCPU â€¢ 100GB SSD |"
            echo "| **OS** | Ubuntu 22.04 LTS |"
            echo ""
            echo "### ğŸŒ Access:"
            echo ""
            echo "**SSH:**"
            echo \'\`\`\`bash\'
            echo "ssh root@$(cat .droplet_ip)"
            echo \'\`\`\`\'
            echo ""
            echo "**KASM Workspace:**"
            echo \'\`\`\`\'
            echo "https://$(cat .droplet_ip):443"
            echo "Username: admin@kasm.local"
            echo \'\`\`\`\'
            echo ""
            echo "### â±ï¸ Important Notes:"
            echo "- Software installation may take 5-15 minutes"
            echo "- You can check installation progress:"
            echo "  \`ssh root@$(cat .droplet_ip) tail -f /var/log/kasm-install.log\`"
            echo ""
            echo "### ğŸ“¦ Installed Software:"
            echo "- âœ… KASM Workspace (Desktop Environment)"
            echo "- âœ… Node.js 20"
            echo "- âœ… Python 3"
            echo "- âœ… Docker"
            echo "- âœ… Git & Development Tools"
            echo ""
            echo "### ğŸ’° Cost:"
            echo "**Memory-Optimized 32GB:** \$250/month (\$0.347/hour)"
            echo ""
            echo "### ğŸ—‘ï¸ Delete Server:"
            echo "When done, use the **Delete Server** workflow to remove the server."
          } >> $GITHUB_STEP_SUMMARY
      
      - name: âŒ Failure Summary Report
        if: failure()
        run: |
          {
            echo "## âŒ Ø³Ø±ÙˆØ± Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø¯!"
            echo ""
            echo "### ğŸ” Troubleshooting:"
            echo ""
            echo "1. **Check Secrets Configuration:**"
            echo "   - Go to: Settings â†’ Secrets and variables â†’ Actions"
            echo "   - Verify DO_API_TOKEN is set"
            echo "   - Verify SSH_KEY_NAME exists in your DigitalOcean account"
            echo ""
            echo "2. **Check API Token Permissions:**"
            echo "   - Token must have: create_droplets, read_account, read_ssh_keys scopes"
            echo ""
            echo "3. **Check SSH Key:**"
            echo "   - SSH key must exist in DigitalOcean"
            echo "   - Name must match exactly (case-sensitive)"
            echo ""
            echo "4. **Check GitHub Actions Logs:**"
            echo "   - Full logs available in the Actions tab"
            echo ""
            echo "### ğŸ“ Debug Information:"
            echo "- Run ID: ${{ github.run_id }}"
            echo "- Job ID: ${{ github.job }}"
            echo "- Timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          } >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ”” Notify on Failure
        if: failure()
        run: |
          echo "âŒ Workflow failed!"
          echo "Check the logs above for details."
          exit 1
