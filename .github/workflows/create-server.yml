name: ðŸš€ Create Development Server

on:
  workflow_dispatch:
    inputs:
      server_name:
        description: 'ðŸ“ Server Name (Ù†Ø§Ù… Ø³Ø±ÙˆØ±)'
        required: true
        default: 'mahdi-dev-workspace-64gb'
        type: string
      region:
        description: 'ðŸŒ Region (Ù…Ù†Ø·Ù‚Ù‡)'
        required: true
        default: 'fra1'
        type: choice
        options:
          - 'fra1'  # Frankfurt, Germany
          - 'ams3'  # Amsterdam, Netherlands
          - 'lon1'  # London, UK
          - 'nyc1'  # New York, USA
          - 'sfo3'  # San Francisco, USA
          - 'sgp1'  # Singapore
      size_slug:
        description: 'ðŸ’» Server Size/Plan (Ù¾Ù„Ù† Ø³Ø±ÙˆØ±)'
        required: true
      default: 'm-8vcpu-64gb'
      type: choice
      options:
        - 'm-8vcpu-64gb'  # 8 vCPU, 64GB RAM, 200GB SSD
        - 'm-16vcpu-128gb' # 16 vCPU, 128GB RAM, 400GB SSD
                  - 'm-24vcpu-192gb' # 24 vCPU, 192GB RAM, 600GB SSD
        - 'm-32vcpu-256gb' # 32 vCPU, 256GB RAM, 800GB SSD
        - 's-2vcpu-4gb'    # 2 vCPU, 4GB RAM (Testing)
        - 's-4vcpu-8gb'    # 4 vCPU, 8GB RAM (Testing)
      enable_ipv6:
        description: 'ðŸŒ Enable IPv6 (ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ IPv6)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      enable_backups:
        description: 'ðŸ’¾ Enable Backups (ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      custom_tags:
        description: 'ðŸ·ï¸  Custom Tags (Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´ÛŒ - Ø¬Ø¯Ø§ Ø¨Ø§ Ú©Ø§Ù…Ø§)'
        required: false
        type: string

jobs:
  create-server:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Install Dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq curl bc
          echo "âœ… Dependencies installed"
      
      - name: ðŸ” Validate Secrets
        run: |
          if [ -z "${{ secrets.DO_API_TOKEN }}" ]; then
            echo "âŒ DO_API_TOKEN secret not found!"
            exit 1
          fi
          
          if [ -z "${{ secrets.SSH_KEY_NAME }}" ]; then
            echo "âŒ SSH_KEY_NAME secret not found!"
            exit 1
          fi
          
          echo "âœ… All secrets validated"
      
      - name: ðŸ”‘ Get SSH Key ID
        id: ssh_key
        run: |
          echo "ðŸ” Searching for SSH key: ${{ secrets.SSH_KEY_NAME }}"
          
          response=$(curl -s -X GET \
            -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            "https://api.digitalocean.com/v2/account/keys")
          
          ssh_key_id=$(echo "$response" | jq -r ".ssh_keys[] | select(.name==\"${{ secrets.SSH_KEY_NAME }}\") | .id")
          
          if [ -z "$ssh_key_id" ] || [ "$ssh_key_id" = "null" ]; then
            echo "âŒ SSH Key '${{ secrets.SSH_KEY_NAME }}' not found!"
            echo "Available keys:"
            echo "$response" | jq -r '.ssh_keys[] | "  - \(.name) (ID: \(.id))"'
            exit 1
          fi
          
          echo "âœ… Found SSH Key ID: $ssh_key_id"
          echo "ssh_key_id=$ssh_key_id" >> $GITHUB_OUTPUT
      
      - name: ðŸ—ï¸ Create Droplet
        id: create_droplet
        env:
          DO_DROPLET_NAME: ${{ github.event.inputs.server_name }}
          DO_REGION: ${{ github.event.inputs.region }}
          DO_SIZE_SLUG: ${{ github.event.inputs.size_slug }}
          DO_ENABLE_IPV6: ${{ github.event.inputs.enable_ipv6 }}
          DO_ENABLE_BACKUPS: ${{ github.event.inputs.enable_backups }}
          DO_TAGS: ${{ github.event.inputs.custom_tags }}
          DO_API_TOKEN: ${{ secrets.DO_API_TOKEN }}
          SSH_KEY_NAME: ${{ secrets.SSH_KEY_NAME }}
        run: |
          echo "## ðŸ—ï¸ Creating Server" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Configuration | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| **Name** | \`${{ github.event.inputs.server_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Region** | \`${{ github.event.inputs.region }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Size** | \`${{ github.event.inputs.size_slug }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **IPv6** | ${{ github.event.inputs.enable_ipv6 }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Backups** | ${{ github.event.inputs.enable_backups }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Ú†Ú© Ú©Ø±Ø¯Ù† size Ø¯Ø± DigitalOcean
          response=$(curl -s -X GET \
            -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
            "https://api.digitalocean.com/v2/sizes?regions=${{ github.event.inputs.region }}")
          
          size_available=$(echo "$response" | jq -r ".sizes[] | select(.slug==\"${{ github.event.inputs.size_slug }}\") | .available")
          
          if [ "$size_available" != "true" ]; then
            echo "âš ï¸  Warning: Size may not be available in this region"
            echo "**Warning:** Size may not be available in region" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Ø§Ø¬Ø±Ø§ÛŒ script create-server.sh
          bash ./create-server.sh
          
          # Ø®ÙˆØ§Ù†Ø¯Ù† Droplet ID
          if [ -f ".droplet_id" ]; then
            droplet_id=$(cat .droplet_id)
            echo "droplet_id=$droplet_id" >> $GITHUB_OUTPUT
          fi
      
      - name: â³ Wait for Server Activation
        id: wait_active
        run: |
          droplet_id=${{ steps.create_droplet.outputs.droplet_id }}
          max_attempts=60
          attempt=0
          status=""
          
          echo "â³ Waiting for droplet to become active..."
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â³ Activation Progress" >> $GITHUB_STEP_SUMMARY
          
          while [ "$status" != "active" ] && [ $attempt -lt $max_attempts ]; do
            sleep 10
            attempt=$((attempt + 1))
            
            response=$(curl -s -X GET \
              -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
              "https://api.digitalocean.com/v2/droplets/$droplet_id")
            
            status=$(echo "$response" | jq -r '.droplet.status')
            progress=$((attempt * 100 / max_attempts))
            
            echo "[â³] Status: $status | Progress: ${progress}% | Attempt: ${attempt}/${max_attempts}"
          done
          
          if [ "$status" != "active" ]; then
            echo "âŒ Droplet failed to activate within timeout"
            echo "**Status:** âŒ Activation timeout" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "âœ… Droplet is now active!"
          echo "**Status:** âœ… Active (took ${attempt}0 seconds)" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ“Š Get Server Information
        id: server_info
        run: |
          droplet_id=${{ steps.create_droplet.outputs.droplet_id }}
          
          response=$(curl -s -X GET \
            -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
            "https://api.digitalocean.com/v2/droplets/$droplet_id")
          
          ipv4=$(echo "$response" | jq -r '.droplet.networks.v4[] | select(.type=="public") | .ip_address')
          ipv6=$(echo "$response" | jq -r '.droplet.networks.v6[] | select(.type=="public") | .ip_address')
          region=$(echo "$response" | jq -r '.droplet.region.slug')
          size_slug=$(echo "$response" | jq -r '.droplet.size_slug')
          memory=$(echo "$response" | jq -r '.droplet.memory')
          vcpus=$(echo "$response" | jq -r '.droplet.vcpus')
          disk=$(echo "$response" | jq -r '.droplet.disk')
          
          echo "ipv4=$ipv4" >> $GITHUB_OUTPUT
          echo "ipv6=$ipv6" >> $GITHUB_OUTPUT
          echo "region=$region" >> $GITHUB_OUTPUT
          echo "size_slug=$size_slug" >> $GITHUB_OUTPUT
          echo "memory=$memory" >> $GITHUB_OUTPUT
          echo "vcpus=$vcpus" >> $GITHUB_OUTPUT
          echo "disk=$disk" >> $GITHUB_OUTPUT
          
          # Save to file for artifact
          echo "$droplet_id" > .droplet_id
          echo "$ipv4" > .droplet_ip
          echo "$ipv6" > .droplet_ipv6
          echo "$size_slug" > .droplet_size
          echo "$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")" > .droplet_created_at
          
          echo "âœ… Server information collected"
      
      - name: ðŸ’¾ Save Server Information
        uses: actions/upload-artifact@v4
        with:
          name: server-info
          path: |
            .droplet_id
            .droplet_ip
            .droplet_ipv6
            .droplet_size
            .droplet_created_at
          retention-days: 30
      
      - name: ðŸ“‹ Success Summary
        if: success()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ## ðŸŽ‰ Ø³Ø±ÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯!
          
          ### ðŸ“‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³Ø±ÙˆØ±
          
          | Ù…ÙˆØ±Ø¯ | Ù…Ù‚Ø¯Ø§Ø± |
          |------|-------|
          | **ðŸ†” Server ID** | `${{ steps.create_droplet.outputs.droplet_id }}` |
          | **ðŸ“ Server Name** | `${{ github.event.inputs.server_name }}` |
          | **ðŸŒ IPv4** | `${{ steps.server_info.outputs.ipv4 }}` |
          | **ðŸŒ IPv6** | `${{ steps.server_info.outputs.ipv6 }}` |
          | **ðŸŒ Region** | `${{ steps.server_info.outputs.region }}` |
          | **ðŸ’» Plan** | `${{ github.event.inputs.size_slug }}` |
          | **ðŸ§  RAM** | `${{ steps.server_info.outputs.memory }}MB` |
          | **ðŸ”¥ vCPU** | `${{ steps.server_info.outputs.vcpus }}` |
          | **âš¡ Disk** | `${{ steps.server_info.outputs.disk }}GB` |
          
          ### ðŸ”— Ø¯Ø³ØªÙˆØ±Ø§Øª Ø§ØªØµØ§Ù„
          
          **SSH Connection:**
          ```bash
          ssh root@${{ steps.server_info.outputs.ipv4 }}
          ```
          
          **KASM Workspace (Ø¯Ø³Ú©ØªØ§Ù¾ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø±):**
          ```
          https://${{ steps.server_info.outputs.ipv4 }}:443
          ```
          
          **RustDesk Server (Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø² Ø±Ø§Ù‡ Ø¯ÙˆØ±):**
          ```
          Server: ${{ steps.server_info.outputs.ipv4 }}
          Ports: 21115-21119
          ```
          
          Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù„ÛŒØ¯ Ø¹Ù…ÙˆÙ…ÛŒ:
          ```bash
          ssh root@${{ steps.server_info.outputs.ipv4 }} cat /root/rustdesk-public-key.txt
          ```
          
          ### âš ï¸ Ù†Ú©Ø§Øª Ù…Ù‡Ù…
          
          - ðŸ’° **Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù Ø³Ø±ÙˆØ±** Ø§Ø² workflow "Delete Development Server" Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
          - ðŸ” **Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³Ø±ÙˆØ±** Ø¯Ø± Artifacts Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª
          - â±ï¸ **Ù†ØµØ¨ Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø±Ù‡Ø§** Ûµ-Û²Û° Ø¯Ù‚ÛŒÙ‚Ù‡ Ø·ÙˆÙ„ Ù…ÛŒâ€ŒÚ©Ø´Ø¯
          - ðŸ“Š **Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„Ø§Ú¯ Ù†ØµØ¨:** `ssh root@${{ steps.server_info.outputs.ipv4 }} tail -f /var/log/server-install.log`
          - ðŸ“‹ **Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù…Ù„ Ø³Ø±ÙˆØ±:** `ssh root@${{ steps.server_info.outputs.ipv4 }} /root/server-info.sh`
          
          ### ðŸŽ¯ Ù…Ø±Ø§Ø­Ù„ Ø¨Ø¹Ø¯ÛŒ
          
          1. Ø§Ø² Ø·Ø±ÛŒÙ‚ SSH Ø¨Ù‡ Ø³Ø±ÙˆØ± Ù…ØªØµÙ„ Ø´ÙˆÛŒØ¯
          2. Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø±Ù‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø±Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
          3. Ù¾Ø±ÙˆÚ˜Ù‡ Ø®ÙˆØ¯ Ø±Ø§ deploy Ú©Ù†ÛŒØ¯
          4. **Ø¨Ø¹Ø¯ Ø§Ø² Ø§ØªÙ…Ø§Ù… Ú©Ø§Ø±ØŒ Ø³Ø±ÙˆØ± Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯** (ØªØ§ Ù‡Ø²ÛŒÙ†Ù‡ Ù†Ø´ÙˆØ¯)
          
          ---
          
          **âœ¨ Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÛŒÙ… - Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´ÛŒØ¯!**
          EOF
      
      - name: âŒ Error Notification
        if: failure()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ## âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø±ÙˆØ±
          
          Ù„Ø·ÙØ§ Ù…ÙˆØ§Ø±Ø¯ Ø²ÛŒØ± Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯:
          
          - âœ… API Token Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª
          - âœ… SSH Key Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª
          - âœ… Ù…Ù†Ø·Ù‚Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ù¾Ù„Ø§Ù† Ø±Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
          - âœ… Ø­Ø¯ Ø³Ø±ÙˆØ± Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ DigitalOcean ÙØ¹Ø§Ù„ Ø§Ø³Øª
          
          Ø¨Ø±Ø§ÛŒ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ±ØŒ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Workflow Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.
          EOF
