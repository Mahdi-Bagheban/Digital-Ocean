name: ğŸš€ Create DigitalOcean Server with RustDesk

on:
  workflow_dispatch:
    inputs:
      server_name:
        description: 'ğŸ“ Server Name | Ù†Ø§Ù… Ø³Ø±ÙˆØ±'
        required: true
        default: 'rustdesk-server'
        type: string

      region:
        description: 'ğŸŒ Region | Ù…Ù†Ø·Ù‚Ù‡'
        required: true
        default: 'fra1 - ğŸ‡©ğŸ‡ª Frankfurt (Ø¨Ù‡ØªØ±ÛŒÙ† Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ±Ø§Ù†)'
        type: choice
        options:
          - 'fra1 - ğŸ‡©ğŸ‡ª Frankfurt (Ø¨Ù‡ØªØ±ÛŒÙ† Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ±Ø§Ù†) â­'
          - 'ams3 - ğŸ‡³ğŸ‡± Amsterdam (Ù‡Ù„Ù†Ø¯)'
          - 'lon1 - ğŸ‡¬ğŸ‡§ London (Ø§Ù†Ú¯Ù„ÛŒØ³)'
          - 'nyc1 - ğŸ‡ºğŸ‡¸ New York (Ø¢Ù…Ø±ÛŒÚ©Ø§)'
          - 'sfo3 - ğŸ‡ºğŸ‡¸ San Francisco (Ú©Ø§Ù„ÛŒÙØ±Ù†ÛŒØ§)'
          - 'sgp1 - ğŸ‡¸ğŸ‡¬ Singapore (Ø¢Ø³ÛŒØ§)'

      size_slug:
        description: 'ğŸ’ª Server Plan | Ù¾Ù„Ù† Ø³Ø±ÙˆØ±'
        required: true
        default: 's-2vcpu-4gb-intel - ğŸŒ± Small ($26/mo) - ØªÙˆØµÛŒÙ‡ Ø´Ø¯Ù‡'
        type: choice
        options:
          - 's-1vcpu-512mb-10gb - ğŸŸ¢ Nano ($4/mo) - ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ ØªØ³Øª'
          - 's-2vcpu-4gb-intel - ğŸŒ± Small ($26/mo) - ØªÙˆØµÛŒÙ‡ Ø´Ø¯Ù‡ â­'
          - 's-4vcpu-8gb-intel - ğŸ”¥ Standard ($52/mo)'
          - 'm-2vcpu-16gb - ğŸ‘‘ High Memory ($98/mo)'
          - 'm-8vcpu-64gb-intel - ğŸš€ Enterprise ($435/mo)'

jobs:
  create-server:
    name: ğŸ—ï¸ Create & Setup Server
    runs-on: ubuntu-latest
    timeout-minutes: 45

    outputs:
      droplet_id: ${{ steps.create.outputs.droplet_id }}
      server_ip: ${{ steps.info.outputs.ipv4 }}
      server_ipv6: ${{ steps.info.outputs.ipv6 }}
      server_name: ${{ github.event.inputs.server_name }}

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”§ Install Dependencies
        run: |
          echo "ğŸ“¦ Installing required tools..."
          sudo apt-get update -qq
          sudo apt-get install -y jq curl bc qrencode 2>&1 | tail -2
          echo "âœ… Tools installed successfully"

      - name: ğŸ“‹ Parse Configuration
        id: parse
        run: |
          region_input="${{ github.event.inputs.region }}"
          region_code=$(echo "$region_input" | cut -d' ' -f1)
          
          size_input="${{ github.event.inputs.size_slug }}"
          size_code=$(echo "$size_input" | cut -d' ' -f1)
          
          echo "region_code=$region_code" >> $GITHUB_OUTPUT
          echo "size_code=$size_code" >> $GITHUB_OUTPUT
          
          echo "ğŸ“ Configuration parsed:"
          echo "   Region: $region_code"
          echo "   Plan: $size_code"
          echo "   Server: ${{ github.event.inputs.server_name }}"

      - name: ğŸ—ï¸ Create Droplet
        id: create
        run: |
          echo "ğŸ—ï¸ Creating Ubuntu 24.04 LTS Droplet..."
          echo "   Region: ${{ steps.parse.outputs.region_code }}"
          echo "   Plan: ${{ steps.parse.outputs.size_code }}"
          echo ""
          
          response=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "name": "${{ github.event.inputs.server_name }}",
              "region": "${{ steps.parse.outputs.region_code }}",
              "size": "${{ steps.parse.outputs.size_code }}",
              "image": "ubuntu-24-04-x64",
              "ssh_keys": ["MahdiArts"],
              "backups": false,
              "ipv6": true,
              "monitoring": true,
              "tags": ["github-actions", "rustdesk", "automated"]
            }' \
            "https://api.digitalocean.com/v2/droplets")
          
          droplet_id=$(echo "$response" | jq -r '.droplet.id // empty')
          
          if [ -z "$droplet_id" ]; then
            echo "âŒ Failed to create droplet"
            echo "$response" | jq '.' 2>/dev/null || echo "$response"
            exit 1
          fi
          
          echo "droplet_id=$droplet_id" >> $GITHUB_OUTPUT
          echo "âœ… Droplet created: ID $droplet_id"

      - name: â³ Wait for Activation
        run: |
          droplet_id="${{ steps.create.outputs.droplet_id }}"
          echo "â³ Waiting for droplet to become active..."
          
          for i in {1..60}; do
            response=$(curl -s -X GET \
              -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
              "https://api.digitalocean.com/v2/droplets/$droplet_id")
            
            status=$(echo "$response" | jq -r '.droplet.status // "unknown"')
            
            if [ "$status" = "active" ]; then
              echo "âœ… Droplet is ACTIVE ($((i*2))s)"
              exit 0
            fi
            
            if [ $((i % 15)) -eq 0 ]; then
              echo "   Status: $status [${i}/60]"
            fi
            
            sleep 2
          done
          
          echo "âŒ Timeout waiting for activation"
          exit 1

      - name: ğŸ“Š Get Network Info
        id: info
        run: |
          droplet_id="${{ steps.create.outputs.droplet_id }}"
          echo "ğŸ“Š Retrieving network information..."
          
          response=$(curl -s -X GET \
            -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
            "https://api.digitalocean.com/v2/droplets/$droplet_id")
          
          ipv4=$(echo "$response" | jq -r '.droplet.networks.v4[] | select(.type=="public") | .ip_address' | head -1)
          ipv6=$(echo "$response" | jq -r '.droplet.networks.v6[0].ip_address // "N/A"')
          
          if [ -z "$ipv4" ]; then
            echo "âŒ Failed to get IPv4 address"
            exit 1
          fi
          
          echo "ipv4=$ipv4" >> $GITHUB_OUTPUT
          echo "ipv6=$ipv6" >> $GITHUB_OUTPUT
          
          echo "âœ… Network info retrieved:"
          echo "   IPv4: $ipv4"
          echo "   IPv6: $ipv6"

      - name: ğŸ” Setup SSH
        run: |
          echo "ğŸ” Configuring SSH..."
          
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          if grep -q "BEGIN OPENSSH PRIVATE KEY" ~/.ssh/id_rsa; then
            echo "âœ… SSH key configured (ED25519)"
          else
            echo "âŒ Invalid SSH key format"
            exit 1
          fi

      - name: ğŸ¥ Test SSH Access
        run: |
          ip="${{ steps.info.outputs.ipv4 }}"
          echo "ğŸ¥ Checking SSH availability..."
          
          for i in {1..60}; do
            if timeout 3 bash -c "echo > /dev/tcp/$ip/22" 2>/dev/null; then
              echo "âœ… SSH is ready"
              sleep 1
              exit 0
            fi
            
            if [ $((i % 15)) -eq 0 ]; then
              echo "   Waiting... [${i}/60]"
            fi
            
            sleep 2
          done
          
          echo "âš ï¸ SSH timeout - continuing anyway"

      - name: ğŸ”§ Execute Setup
        run: |
          cat > /tmp/init.sh << 'INIT'
          #!/bin/bash
          set -e
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš€ SERVER INITIALIZATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # System update
          echo "ğŸ“¦ [1/8] Updating system..."
          sudo apt-get update -qq
          sudo apt-get upgrade -y -qq
          sudo apt-get install -y curl wget git build-essential 2>&1 | tail -1
          echo "âœ… System updated"
          echo ""
          
          # Docker
          echo "ğŸ³ [2/8] Installing Docker..."
          curl -fsSL https://get.docker.com -o /tmp/docker.sh
          sudo sh /tmp/docker.sh > /dev/null 2>&1
          sudo usermod -aG docker root
          sudo systemctl start docker
          sudo systemctl enable docker
          echo "âœ… Docker installed"
          echo ""
          
          # Node.js
          echo "ğŸ“¦ [3/8] Installing Node.js..."
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash - > /dev/null 2>&1
          sudo apt-get install -y nodejs 2>&1 | tail -1
          echo "âœ… Node.js $(node -v) installed"
          echo ""
          
          # Python
          echo "ğŸ [4/8] Installing Python..."
          sudo apt-get install -y python3 python3-pip python3-dev python3-venv 2>&1 | tail -1
          echo "âœ… Python 3 installed"
          echo ""
          
          # Dev tools
          echo "ğŸ› ï¸ [5/8] Installing dev tools..."
          sudo apt-get install -y git nano vim curl wget jq htop 2>&1 | tail -1
          echo "âœ… Dev tools installed"
          echo ""
          
          # Firewall
          echo "ğŸ”¥ [6/8] Setting up firewall..."
          sudo apt-get install -y ufw 2>&1 | tail -1
          sudo ufw default deny incoming
          sudo ufw default allow outgoing
          sudo ufw allow 22/tcp
          sudo ufw allow 80/tcp
          sudo ufw allow 443/tcp
          sudo ufw allow 5900:5901/tcp
          sudo ufw allow 21115:21119/tcp
          sudo ufw enable > /dev/null 2>&1
          echo "âœ… Firewall configured"
          echo ""
          
          # RustDesk
          echo "ğŸ¦€ [7/8] Installing RustDesk..."
          sudo mkdir -p /opt/rustdesk
          cd /opt/rustdesk
          RUSTDESK_VERSION="1.41.9"
          wget -q "https://github.com/rustdesk/rustdesk-server/releases/download/$RUSTDESK_VERSION/rustdesk-server-linux-x64.zip"
          unzip -q rustdesk-server-linux-x64.zip
          rm rustdesk-server-linux-x64.zip
          sudo chmod +x hbbr hbbs
          echo "âœ… RustDesk $RUSTDESK_VERSION installed"
          echo ""
          
          # Services
          echo "âš™ï¸ [8/8] Starting services..."
          
          sudo tee /etc/systemd/system/rustdesk-hbbs.service > /dev/null << 'SRVHBBS'
          [Unit]
          Description=RustDesk Signal Server
          After=network.target
          
          [Service]
          Type=simple
          User=root
          WorkingDirectory=/opt/rustdesk
          ExecStart=/opt/rustdesk/hbbs
          Restart=on-failure
          RestartSec=5
          StandardOutput=journal
          StandardError=journal
          
          [Install]
          WantedBy=multi-user.target
          SRVHBBS
          
          sudo tee /etc/systemd/system/rustdesk-hbbr.service > /dev/null << 'SRVHBBR'
          [Unit]
          Description=RustDesk Relay Server
          After=network.target rustdesk-hbbs.service
          
          [Service]
          Type=simple
          User=root
          WorkingDirectory=/opt/rustdesk
          ExecStart=/opt/rustdesk/hbbr
          Restart=on-failure
          RestartSec=5
          StandardOutput=journal
          StandardError=journal
          
          [Install]
          WantedBy=multi-user.target
          SRVHBBR
          
          sudo systemctl daemon-reload
          sudo systemctl enable rustdesk-hbbs rustdesk-hbbr 2>/dev/null
          sudo systemctl start rustdesk-hbbs rustdesk-hbbr
          sleep 2
          
          if sudo systemctl is-active rustdesk-hbbs > /dev/null; then
            echo "âœ… RustDesk services started"
          else
            echo "âš ï¸ Services initializing..."
          fi
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… INITIALIZATION COMPLETE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          INIT
          
          chmod +x /tmp/init.sh
          
          echo "ğŸš€ Executing initialization..."
          ssh -o StrictHostKeyChecking=accept-new \
              -o UserKnownHostsFile=/dev/null \
              -o ConnectTimeout=10 \
              -i ~/.ssh/id_rsa \
              root@${{ steps.info.outputs.ipv4 }} \
              'bash -s' < /tmp/init.sh
          
          echo "âœ… Initialization complete"

      - name: ğŸ”‘ Extract RustDesk Key
        id: rustdesk
        run: |
          echo "ğŸ”‘ Extracting RustDesk key..."
          key=""
          for attempt in {1..15}; do
            key=$(ssh -o StrictHostKeyChecking=accept-new \
                      -o UserKnownHostsFile=/dev/null \
                      -o ConnectTimeout=5 \
                      -i ~/.ssh/id_rsa \
                      root@${{ steps.info.outputs.ipv4 }} \
                      'cat /opt/rustdesk/id_ed25519.pub' 2>/dev/null || true)
            if [ -n "$key" ]; then
              echo "âœ… Key extracted (attempt $attempt)"
              break
            fi
            echo "   Waiting... [$attempt/15]"
            sleep 2
          done
          
          if [ -z "$key" ]; then
            key="KEY_PENDING_FIRST_CONNECTION"
          fi
          echo "rustdesk_key=$key" >> $GITHUB_OUTPUT

      - name: ğŸ“„ Generate Guide
        run: |
          mkdir -p /tmp/guides
          cat > /tmp/guides/CONNECTION_GUIDE.md << 'GUIDE'
          # ğŸš€ RustDesk Server - Quick Start
          
          ## ğŸ“± Server Details
          
          | Item | Value |
          |------|-------|
          | **Name** | ${{ github.event.inputs.server_name }} |
          | **IPv4** | `${{ steps.info.outputs.ipv4 }}` |
          | **IPv6** | `${{ steps.info.outputs.ipv6 }}` |
          | **Region** | ${{ steps.parse.outputs.region_code }} |
          | **Status** | âœ… Ready |
          
          ## ğŸ”— Connect (3 Steps)
          
          1. Download RustDesk from https://rustdesk.com
          2. Enter IP: `${{ steps.info.outputs.ipv4 }}`
          3. Click Connect
          
          ## ğŸ“¦ Installed
          
          âœ… Ubuntu 24.04 LTS  
          âœ… Docker  
          âœ… Node.js LTS  
          âœ… Python 3  
          âœ… RustDesk Server  
          âœ… Firewall  
          
          ## ğŸ—‘ï¸ Delete Server
          
          Run: `Delete DigitalOcean Server` workflow  
          Enter: `${{ github.event.inputs.server_name }}`
          GUIDE
          
          echo "âœ… Guide generated"

      - name: ğŸ“¸ Generate QR Code
        run: |
          qrencode -o /tmp/guides/QR_CODE.png "${{ steps.info.outputs.ipv4 }}" -s 10 -m 2
          echo "âœ… QR code generated"

      - name: ğŸ“¦ Create Release
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: v1.0-${{ steps.create.outputs.droplet_id }}-${{ github.run_id }}
          name: ğŸ‰ ${{ github.event.inputs.server_name }} (ID: ${{ steps.create.outputs.droplet_id }})
          body: |
            # âœ… Server Ready!
            
            **IPv4:** `${{ steps.info.outputs.ipv4 }}`  
            **IPv6:** `${{ steps.info.outputs.ipv6 }}`  
            **Region:** ${{ steps.parse.outputs.region_code }}  
            **Status:** âœ… Operational
            
            ## ğŸš€ Quick Start
            1. Download RustDesk: https://rustdesk.com
            2. Enter IP: `${{ steps.info.outputs.ipv4 }}`
            3. Connect
            
            ## ğŸ“¦ Installed
            âœ… Ubuntu 24.04 LTS  
            âœ… Docker + Node.js + Python  
            âœ… RustDesk Server OSS  
            âœ… UFW Firewall  
            
            ## ğŸ“„ Docs
            See Connection Guide & QR Code in Assets
          files: |
            /tmp/guides/CONNECTION_GUIDE.md
            /tmp/guides/QR_CODE.png
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“‹ Summary
        if: success()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'SUMMARY'
          # âœ… Server Created!
          
          | Field | Value |
          |-------|-------|
          | **Name** | ${{ github.event.inputs.server_name }} |
          | **ID** | ${{ steps.create.outputs.droplet_id }} |
          | **IPv4** | `${{ steps.info.outputs.ipv4 }}` |
          | **IPv6** | `${{ steps.info.outputs.ipv6 }}` |
          | **Region** | ${{ steps.parse.outputs.region_code }} |
          
          ## ğŸ¯ Connect Now
          1. Download: https://rustdesk.com
          2. IP: `${{ steps.info.outputs.ipv4 }}`
          3. Connect!
          
          ## ğŸ“¦ What's Installed
          âœ… Ubuntu 24.04 LTS  
          âœ… Docker  
          âœ… Node.js  
          âœ… Python 3  
          âœ… RustDesk Server  
          âœ… Firewall  
          
          ## ğŸ—‘ï¸ Delete When Done
          Go to Actions â†’ Delete DigitalOcean Server
          
          **Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÛŒÙ… - ÛŒØ§ Ø¹Ù„ÛŒ!** ğŸŒŸ
          SUMMARY

      - name: ğŸš¨ Error Summary
        if: failure()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'ERROR'
          # âŒ Creation Failed
          
          ## ğŸ” Troubleshooting
          
          1. **Check Secrets**
             - DO_API_TOKEN valid?
             - SSH_PRIVATE_KEY set?
          
          2. **Check Account**
             - DigitalOcean has credit?
             - SSH key "MahdiArts" exists?
          
          3. **Check Logs**
             - Review step output
             - Look for API errors
          
          4. **Manual Cleanup**
             - Check DigitalOcean dashboard
             - Delete partial droplets
          
          ERROR
