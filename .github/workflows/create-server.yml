name: ðŸš€ Create Development Server with KASM

on:
  workflow_dispatch:
    inputs:
      server_name:
        description: 'ðŸ’» Server Name (Ù†Ø§Ù… Ø³Ø±ÙˆØ±)'
        required: false
        default: 'mahdi-dev-workspace'
      region:
        description: 'ðŸ—ºï¸ Datacenter Region (Ù…Ù†Ø·Ù‚Ù‡ Ø¯ÛŒØªØ§Ø³Ù†ØªØ±)'
        required: false
        default: 'fra1'
        type: choice
        options:
          - fra1  # Frankfurt (ÙØ±Ø§Ù†Ú©ÙÙˆØ±Øª)
          - ams3  # Amsterdam (Ø¢Ù…Ø³ØªØ±Ø¯Ø§Ù…)
          - lon1  # London (Ù„Ù†Ø¯Ù†)
          - nyc1  # New York (Ù†ÛŒÙˆÛŒÙˆØ±Ú©)

jobs:
  create-server:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc curl
      
      - name: ðŸ” Configure Environment
        run: |
          echo "DO_API_TOKEN=${{ secrets.DO_API_TOKEN }}" > .env
          echo "SSH_KEY_NAME=${{ secrets.SSH_KEY_NAME }}" >> .env
          echo "DROPLET_NAME=${{ github.event.inputs.server_name }}" >> .env
          echo "REGION=${{ github.event.inputs.region }}" >> .env
      
      - name: ðŸš€ Create Server
        run: |
          chmod +x create-server.sh
          ./create-server.sh
      
      - name: ðŸ“¤ Save Server Information
        uses: actions/upload-artifact@v4
        with:
          name: server-info
          path: |
            .droplet_id
            .droplet_ip
            .droplet_created_at
          retention-days: 7
      
      - name: ðŸ“Š Summary Report
        if: success()
        run: |
          echo "## ðŸŽ‰ Ø³Ø±ÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Server Information:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Ù…ÙˆØ±Ø¯ | Ù…Ù‚Ø¯Ø§Ø± |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Server ID** | \`$(cat .droplet_id)\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Server IP** | \`$(cat .droplet_ip)\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Server Name** | ${{ github.event.inputs.server_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Region** | ${{ github.event.inputs.region }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Specs** | 32GB RAM â€¢ 2 vCPU â€¢ 100GB SSD |" >> $GITHUB_STEP_SUMMARY
          echo "| **OS** | Ubuntu 22.04 LTS |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Access:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**SSH:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "ssh root@$(cat .droplet_ip)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**KASM Workspace:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "https://$(cat .droplet_ip):443" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â±ï¸ Installation Note:" >> $GITHUB_STEP_SUMMARY
          echo "**Software installation may take 5-15 minutes. Please wait...**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Installed Software:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… KASM Workspace (Desktop Environment)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Node.js 20" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Python 3" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Docker" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Git & Development Tools" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’° Cost:" >> $GITHUB_STEP_SUMMARY
          echo "**Memory-Optimized 32GB:** \$250/month (\$0.347/hour)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ—‘ï¸ Delete Server:" >> $GITHUB_STEP_SUMMARY
          echo "When done, use the **Delete Server** workflow to remove the server." >> $GITHUB_STEP_SUMMARY
