# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘ ðŸš€ DigitalOcean Server Automation Workflow â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ðŸ“ Purpose: Ø§ØªÙˆÙ…Ø§Ø³ÛŒÙˆÙ† Ú©Ø§Ù…Ù„ Ø§ÛŒØ¬Ø§Ø¯ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ DigitalOcean
# ðŸš€ Version: 8.0 (Production Ready - MahdiArts Edition)
# ðŸŽ‰ Features: KASM Workspace + RustDesk Server + Full Automation
# ðŸ‘¤ Author: Mahdi Bagheban
# ðŸ“… Updated: December 2025

name: ðŸš€ Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø±ÙˆØ± DigitalOcean | Create Server

on:
  workflow_dispatch:
    inputs:
      server_name:
        description: 'ðŸ“ Ù†Ø§Ù… Ø³Ø±ÙˆØ± | Server Name'
        required: true
        default: 'MahdiArts'
        type: string
        
      region:
        description: 'ðŸŒ Ù…Ù†Ø·Ù‚Ù‡ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ | Region'
        required: true
        default: 'fra1'
        type: choice
        options:
          - 'fra1 - ðŸŒ Frankfurt (Ø¨Ù‡ØªØ±ÛŒÙ† Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ±Ø§Ù†)'
          - 'ams3 - ðŸŒ Amsterdam (Ù‡Ù„Ù†Ø¯)'
          - 'lon1 - ðŸŒ London (Ø§Ù†Ú¯Ù„ÛŒØ³)'
          - 'nyc1 - ðŸŒ New York (Ù†ÛŒÙˆÛŒÙˆØ±Ú©)'
          - 'sfo3 - ðŸŒ San Francisco (Ú©Ø§Ù„ÛŒÙØ±Ù†ÛŒØ§)'
          - 'sgp1 - ðŸŒ Singapore (Ø¢Ø³ÛŒØ§)'
          
      size_slug:
        description: 'ðŸ’ª Ù¾Ù„Ù† Ø³Ø±ÙˆØ± | Server Plan'
        required: true
        default: 's-4vcpu-8gb-intel'
        type: choice
        options:
          - 'ðŸŒ± s-2vcpu-4gb-intel - 2 Ù…Ø¹Ù…ÙˆÙ„ÛŒ: CPU, 4GB RAM ($26/mo)'
          - 'ðŸ”¥ s-4vcpu-8gb-intel - 4 Ù‚Ø¯Ø±ØªÙ…Ù†Ø¯: CPU, 8GB RAM ($52/mo)'
          - 'ðŸ‘‘ m-2vcpu-16gb - 2 Ø®ÛŒÙ„ÛŒ Ù‚Ø¯Ø±ØªÙ…Ù†Ø¯: CPU, 16GB RAM ($98/mo)'
          - 'ðŸš€ m-8vcpu-64gb-intel - 8 ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡: CPU, 64GB RAM ($435/mo)'
          - 'âš¡ m-16vcpu-128gb-intel - 32 Ù…Ø¹Ù…ÙˆÙ„ÛŒ: CPU, 256GB RAM ($1740/mo)'

jobs:
  create-server:
    name: ðŸ—ï¸ Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø±ÙˆØ±
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ðŸ“¥ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯
        uses: actions/checkout@v4

      - name: ðŸ”§ Ù†ØµØ¨ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq curl bc
          echo "âœ… Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ Ù†ØµØ¨ Ø´Ø¯Ù†Ø¯"

      - name: ðŸ”‘ Ø¯Ø±ÛŒØ§ÙØª SSH Key ID
        id: ssh_key
        run: |
          echo "ðŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ SSH Key..."
          
          response=$(curl -s -X GET \
            -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            "https://api.digitalocean.com/v2/account/keys")
          
          ssh_key_id=$(echo "$response" | jq -r '.ssh_keys[] | select(.name=="${{ secrets.SSH_KEY_NAME }}") | .id')
          
          if [ -z "$ssh_key_id" ] || [ "$ssh_key_id" = "null" ]; then
            echo "âŒ SSH Key Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯: ${{ secrets.SSH_KEY_NAME }}"
            exit 1
          fi
          
          echo "ssh_key_id=$ssh_key_id" >> $GITHUB_OUTPUT
          echo "âœ… SSH Key Ù¾ÛŒØ¯Ø§ Ø´Ø¯: $ssh_key_id"

      - name: ðŸŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Region Code
        id: region
        run: |
          region_input="${{ github.event.inputs.region }}"
          region_code=$(echo "$region_input" | cut -d' ' -f1)
          echo "region_code=$region_code" >> $GITHUB_OUTPUT
          echo "âœ… Region: $region_code"

      - name: ðŸ’ª Ø§Ø³ØªØ®Ø±Ø§Ø¬ Size Slug
        id: size
        run: |
          size_input="${{ github.event.inputs.size_slug }}"
          size_code=$(echo "$size_input" | cut -d' ' -f2)
          echo "size_code=$size_code" >> $GITHUB_OUTPUT
          echo "âœ… Size: $size_code"

      - name: ðŸ—ï¸ Ø§ÛŒØ¬Ø§Ø¯ Droplet
        id: create
        run: |
          echo "ðŸ—ï¸ Ø¯Ø± Ø­Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø±ÙˆØ±..."
          
          response=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "name": "${{ github.event.inputs.server_name }}",
              "region": "${{ steps.region.outputs.region_code }}",
              "size": "${{ steps.size.outputs.size_code }}",
              "image": "ubuntu-24-04-x64",
              "ssh_keys": [${{ steps.ssh_key.outputs.ssh_key_id }}],
              "backups": false,
              "ipv6": true,
              "monitoring": true,
              "tags": ["github-actions", "mahdiarts", "automated"]
            }' \
            "https://api.digitalocean.com/v2/droplets")
          
          droplet_id=$(echo "$response" | jq -r '.droplet.id')
          
          if [ -z "$droplet_id" ] || [ "$droplet_id" = "null" ]; then
            echo "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø±ÙˆØ±"
            echo "$response" | jq .
            exit 1
          fi
          
          echo "droplet_id=$droplet_id" >> $GITHUB_OUTPUT
          echo "âœ… Ø³Ø±ÙˆØ± Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯ - Droplet ID: $droplet_id"

      - name: â³ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ
        run: |
          droplet_id="${{ steps.create.outputs.droplet_id }}"
          echo "â³ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø³Ø±ÙˆØ±..."
          
          for i in {1..60}; do
            response=$(curl -s -X GET \
              -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
              "https://api.digitalocean.com/v2/droplets/$droplet_id")
            
            status=$(echo "$response" | jq -r '.droplet.status')
            
            if [ "$status" = "active" ]; then
              echo "âœ… Ø³Ø±ÙˆØ± ÙØ¹Ø§Ù„ Ø´Ø¯!"
              exit 0
            fi
            
            echo "[$i/60] ÙˆØ¶Ø¹ÛŒØª: $status - ØµØ¨Ø± Ú©Ù†ÛŒØ¯..."
            sleep 10
          done
          
          echo "âŒ ØªØ§ÛŒÙ…â€ŒØ§ÙˆØª: Ø³Ø±ÙˆØ± ÙØ¹Ø§Ù„ Ù†Ø´Ø¯"
          exit 1

      - name: ðŸ“Š Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³Ø±ÙˆØ±
        id: info
        run: |
          droplet_id="${{ steps.create.outputs.droplet_id }}"
          
          response=$(curl -s -X GET \
            -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
            "https://api.digitalocean.com/v2/droplets/$droplet_id")
          
          ipv4=$(echo "$response" | jq -r '.droplet.networks.v4[0].ip_address')
          ipv6=$(echo "$response" | jq -r '.droplet.networks.v6[0].ip_address // "N/A"')
          
          echo "ipv4=$ipv4" >> $GITHUB_OUTPUT
          echo "ipv6=$ipv6" >> $GITHUB_OUTPUT
          
          echo "âœ… IP Address (IPv4): $ipv4"
          echo "âœ… IP Address (IPv6): $ipv6"

      - name: ðŸ¥ Ø¨Ø±Ø±Ø³ÛŒ Ø³Ù„Ø§Ù…Øª Ø³Ø±ÙˆØ±
        run: |
          ip="${{ steps.info.outputs.ipv4 }}"
          echo "ðŸ¥ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ SSH Ø¨Ù‡ Ø³Ø±ÙˆØ±..."
          
          for i in {1..20}; do
            if timeout 3 bash -c "echo > /dev/tcp/$ip/22" 2>/dev/null; then
              echo "âœ… Ø³Ø±ÙˆØ± Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª! SSH Ø¯Ø± Ø¯Ø³ØªØ±Ø³."
              exit 0
            fi
            echo "[$i/20] Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ SSH..."
            sleep 5
          done
          
          echo "âš ï¸ SSH Ù‡Ù†ÙˆØ² Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª (Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø·ÙˆÙ„ Ø¨Ú©Ø´Ø¯)"

      - name: ðŸ“‹ Ù†Ù…Ø§ÛŒØ´ Ø®Ù„Ø§ØµÙ‡
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸŽ‰ Ø³Ø±ÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯!
          
          ## ðŸ“Š Ù…Ø´Ø®ØµØ§Øª Ø³Ø±ÙˆØ±
          
          | ðŸ”· Ù¾Ø§Ø±Ø§Ù…ØªØ± | ðŸ“„ Ù…Ù‚Ø¯Ø§Ø± |
          |-----------|----------|
          | **ðŸ·ï¸ Ù†Ø§Ù… Ø³Ø±ÙˆØ±** | `${{ github.event.inputs.server_name }}` |
          | **ðŸ†” Droplet ID** | `${{ steps.create.outputs.droplet_id }}` |
          | **ðŸŒ IP Address (IPv4)** | `${{ steps.info.outputs.ipv4 }}` |
          | **ðŸŒ IP Address (IPv6)** | `${{ steps.info.outputs.ipv6 }}` |
          | **ðŸ—ºï¸ Region** | `${{ steps.region.outputs.region_code }}` |
          | **ðŸ’ª Server Plan** | `${{ steps.size.outputs.size_code }}` |
          
          ## ðŸ”— Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±
          
          ### SSH Access:
          ```bash
          ssh root@${{ steps.info.outputs.ipv4 }}
          ```
          
          ## ðŸŽ¯ Ù…Ø±Ø§Ø­Ù„ Ø¨Ø¹Ø¯ÛŒ
          
          ### Ù†ØµØ¨ KASM Workspace:
          ```bash
          cd /tmp
          curl -O https://kasm-static-content.s3.amazonaws.com/kasm_release_1.15.0.06fdc8.tar.gz
          tar -xf kasm_release_1.15.0.06fdc8.tar.gz
          sudo bash kasm_release/install.sh
          ```
          
          **Ù¾Ø³ Ø§Ø² Ù†ØµØ¨ KASM:**
          - ðŸŒ Ø¢Ø¯Ø±Ø³: `https://${{ steps.info.outputs.ipv4 }}`
          - ðŸ‘¤ Username: `admin@kasm.local`
          - ðŸ”‘ Password: Ø¯Ø± output Ù†ØµØ¨ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
          
          ### Ù†ØµØ¨ RustDesk Server:
          ```bash
          wget https://raw.githubusercontent.com/rustdesk/rustdesk-server/master/install.sh
          chmod +x install.sh
          ./install.sh
          ```
          
          **Ù¾Ø³ Ø§Ø² Ù†ØµØ¨ RustDesk:**
          - ðŸŒ Ø³Ø±ÙˆØ±: `${{ steps.info.outputs.ipv4 }}`
          - ðŸ”‘ Key: Ø¯Ø± ÙØ§ÛŒÙ„ `/var/log/rustdesk-server/` Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª
          
          ## âš ï¸ Ù†Ú©Ø§Øª Ù…Ù‡Ù…
          
          - â³ Ù†ØµØ¨ Ú©Ø§Ù…Ù„ Ù…Ù…Ú©Ù† Ø§Ø³Øª 5-20 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø·ÙˆÙ„ Ø¨Ú©Ø´Ø¯
          - ðŸ” Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª SSH Ø¨Ø§ Ú©Ù„ÛŒØ¯ Ø¹Ù…ÙˆÙ…ÛŒ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª
          - ðŸ’° **Ù‡Ø²ÛŒÙ†Ù‡ Ø³Ø±ÙˆØ± Ø¨Ù‡ ØµÙˆØ±Øª Ø³Ø§Ø¹ØªÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯**
          - ðŸ—‘ï¸ **ÙØ±Ø§Ù…ÙˆØ´ Ù†Ú©Ù†ÛŒØ¯ Ø³Ø±ÙˆØ± Ø±Ø§ Ù¾Ø³ Ø§Ø² Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø­Ø°Ù Ú©Ù†ÛŒØ¯!**
          
          ## ðŸ”— Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ù…ÙÛŒØ¯
          
          - [DigitalOcean Dashboard](https://cloud.digitalocean.com/droplets)
          - [KASM Documentation](https://kasmweb.com/docs/latest/)
          - [RustDesk Documentation](https://rustdesk.com/docs/)
          
          ---
          
          âœ¨ **Ø³Ø±ÙˆØ± Ø´Ù…Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø³Øª!** âœ¨
          
          *Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§ â¤ï¸ ØªÙˆØ³Ø· MahdiArts*
          EOF

      - name: ðŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³Ø±ÙˆØ±
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: server-info-${{ steps.create.outputs.droplet_id }}
          path: |
            ${{ steps.info.outputs.ipv4 }}
          retention-days: 30
