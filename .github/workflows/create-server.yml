name: 'ğŸš€ Create Development Server'

on:
  workflow_dispatch:
    inputs:
      server_name:
        description: 'ğŸ’» Droplet Name (Ù†Ø§Ù… Ø³Ø±ÙˆØ±)'
        required: false
        default: 'mahdi-dev-workspace'
        type: string
      region:
        description: 'ğŸ—ºï¸ Datacenter Region (Ù…Ù†Ø·Ù‚Ù‡)'
        required: false
        default: 'fra1'
        type: choice
        options:
          - fra1      # Frankfurt, Germany
          - ams3      # Amsterdam, Netherlands
          - lon1      # London, UK
          - nyc1      # New York, USA

jobs:
  create-server:
    name: 'ğŸš€ Creating Development Server'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: production
    
    outputs:
      droplet_id: ${{ steps.create.outputs.droplet_id }}
      droplet_ip: ${{ steps.create.outputs.droplet_ip }}
    
    steps:
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # 1ï¸âƒ£ PREPARATION
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      - name: 'ğŸ“¥ Checkout Repository'
        id: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'â° Set Timestamp'
        id: timestamp
        run: |
          echo "START_TIME=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
          echo "START_EPOCH=$(date +%s)" >> $GITHUB_OUTPUT

      - name: 'ğŸ“ Log Configuration'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš€ WORKFLOW STARTED: Create Development Server"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ Configuration:"
          echo "   â€¢ Server Name:     ${{ github.event.inputs.server_name }}"
          echo "   â€¢ Region:          ${{ github.event.inputs.region }}"
          echo "   â€¢ Workflow ID:     ${{ github.run_id }}"
          echo "   â€¢ Attempt:         ${{ github.run_attempt }}"
          echo "   â€¢ Timestamp:       $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
      
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # 2ï¸âƒ£ VALIDATION
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      - name: 'ğŸ” Validate Required Secrets'
        id: validate_secrets
        run: |
          set -e
          
          echo "ğŸ” Validating secrets..."
          
          ERRORS=0
          
          if [ -z "${{ secrets.DO_API_TOKEN }}" ]; then
            echo "âŒ ERROR: DO_API_TOKEN is not configured"
            ERRORS=$((ERRORS + 1))
          else
            echo "âœ… DO_API_TOKEN is configured"
          fi
          
          if [ -z "${{ secrets.SSH_KEY_NAME }}" ]; then
            echo "âŒ ERROR: SSH_KEY_NAME is not configured"
            ERRORS=$((ERRORS + 1))
          else
            echo "âœ… SSH_KEY_NAME is configured"
          fi
          
          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ VALIDATION FAILED: Missing Secrets"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "ğŸ“‹ Setup Instructions:"
            echo ""
            echo "1. Go to GitHub Settings:"
            echo "   https://github.com/Mahdi-Bagheban/Digital-Ocean/settings/secrets/actions"
            echo ""
            echo "2. Add Repository Secrets:"
            echo ""
            echo "   Secret 1:"
            echo "   â€¢ Name: DO_API_TOKEN"
            echo "   â€¢ Value: dop_v1_xxxxxxxxxxxxxxxxxxxxx"
            echo "   â€¢ Get from: https://cloud.digitalocean.com/account/api/tokens"
            echo ""
            echo "   Secret 2:"
            echo "   â€¢ Name: SSH_KEY_NAME"
            echo "   â€¢ Value: MahdiArts (your SSH key name)"
            echo "   â€¢ Get from: https://cloud.digitalocean.com/account/security"
            echo ""
            echo "3. Return here and run the workflow again"
            echo ""
            exit 1
          fi
          
          echo "âœ… All secrets are properly configured"
      
      - name: 'ğŸ“¦ Install Dependencies'
        id: dependencies
        run: |
          echo "ğŸ“¥ Installing system dependencies..."
          
          sudo apt-get update -qq
          sudo apt-get install -y -qq jq bc curl wget
          
          echo "âœ… Dependencies installed successfully"
          echo ""
          echo "ğŸ“‹ Tool Versions:"
          echo "   â€¢ jq:   $(jq --version)"
          echo "   â€¢ curl: $(curl --version | head -n 1)"
          echo "   â€¢ bc:   $(echo | bc -v 2>&1 | head -n 1)"
      
      - name: 'ğŸ“‹ Verify Scripts'
        id: verify_scripts
        run: |
          echo "ğŸ” Verifying required scripts..."
          
          if [ ! -f "create-server.sh" ]; then
            echo "âŒ ERROR: create-server.sh not found"
            echo "ğŸ“ Current directory: $(pwd)"
            echo "ğŸ“ Files:"
            ls -la
            exit 1
          fi
          
          echo "âœ… create-server.sh exists"
          echo "ğŸ“Š Script size: $(wc -l < create-server.sh) lines"
          
          chmod +x create-server.sh
          echo "âœ… Script is executable"
      
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # 3ï¸âƒ£ CONFIGURATION
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      - name: 'âš™ï¸ Setup Environment'
        id: env_setup
        run: |
          echo "ğŸ”§ Configuring environment..."
          
          cat > .env << 'EOF'
DO_API_TOKEN=${{ secrets.DO_API_TOKEN }}
SSH_KEY_NAME=${{ secrets.SSH_KEY_NAME }}
DROPLET_NAME=${{ github.event.inputs.server_name }}
REGION=${{ github.event.inputs.region }}
EOF
          
          if [ ! -f ".env" ]; then
            echo "âŒ Failed to create .env file"
            exit 1
          fi
          
          echo "âœ… Environment configured"
          echo ""
          echo "ğŸ“‹ Configuration Summary:"
          echo "   â€¢ DO_API_TOKEN:    â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
          echo "   â€¢ SSH_KEY_NAME:    ${{ secrets.SSH_KEY_NAME }}"
          echo "   â€¢ DROPLET_NAME:    ${{ github.event.inputs.server_name }}"
          echo "   â€¢ REGION:          ${{ github.event.inputs.region }}"
      
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # 4ï¸âƒ£ EXECUTION
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      - name: 'ğŸš€ Create Development Server'
        id: create
        run: |
          set -e
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš€ EXECUTING: create-server.sh"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          ./create-server.sh
          
          EXIT_CODE=$?
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… Script executed successfully"
            
            if [ -f ".droplet_id" ]; then
              DROPLET_ID=$(cat .droplet_id)
              echo "droplet_id=$DROPLET_ID" >> $GITHUB_OUTPUT
              echo "   â€¢ Droplet ID: $DROPLET_ID"
            fi
            
            if [ -f ".droplet_ip" ]; then
              DROPLET_IP=$(cat .droplet_ip)
              echo "droplet_ip=$DROPLET_IP" >> $GITHUB_OUTPUT
              echo "   â€¢ Droplet IP: $DROPLET_IP"
            fi
          else
            echo "âŒ Script failed with exit code: $EXIT_CODE"
            exit 1
          fi
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # 5ï¸âƒ£ ARTIFACTS
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      - name: 'ğŸ“¤ Upload Artifacts'
        id: upload
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: server-info
          path: |
            .droplet_id
            .droplet_ip
            .droplet_created_at
          retention-days: 7
          if-no-files-found: warn
          compression-level: 9
      
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # 6ï¸âƒ£ REPORTING
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      - name: 'âœ… Success Report'
        id: success_report
        if: success()
        run: |
          DROPLET_IP=$(cat .droplet_ip 2>/dev/null || echo 'N/A')
          DROPLET_ID=$(cat .droplet_id 2>/dev/null || echo 'N/A')
          CREATED_AT=$(cat .droplet_created_at 2>/dev/null || echo 'N/A')
          
          cat > $GITHUB_STEP_SUMMARY << 'SUMMARY'
## ğŸ‰ Ø³Ø±ÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯!

### ğŸ“Š Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³Ø±ÙˆØ±

| Ù…ÙˆØ±Ø¯ | Ù…Ù‚Ø¯Ø§Ø± |
|------|-------|
SUMMARY
          
          echo "| **Droplet ID** | \`$DROPLET_ID\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Server IP** | \`$DROPLET_IP\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Server Name** | ${{ github.event.inputs.server_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Region** | ${{ github.event.inputs.region }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Created At** | $CREATED_AT |" >> $GITHUB_STEP_SUMMARY
          
          cat >> $GITHUB_STEP_SUMMARY << 'SUMMARY'

### ğŸ”Œ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±

**SSH Connection:**
\`\`\`bash
SSH_KEY_PATH=~/.ssh/do-github-actions
SSH_USER=root
SERVER_IP=$(cat .droplet_ip)

ssh -i $SSH_KEY_PATH $SSH_USER@$SERVER_IP
\`\`\`

### ğŸŒ KASM Workspace

**Web Interface:**
\`\`\`
https://SERVER_IP:443
Username: admin@kasm.local
Password: (see installation logs)
\`\`\`

### â³ Installation Status

âš ï¸ **Software installation takes 10-20 minutes after server creation.**

Monitor progress:
\`\`\`bash
ssh root@SERVER_IP tail -f /var/log/kasm-install.log
\`\`\`

### ğŸ“¦ Installed Components

- âœ… KASM Workspace (Remote Desktop)
- âœ… Docker (Container Runtime)
- âœ… Node.js 20.x (JavaScript)
- âœ… Python 3.x (Python)
- âœ… Git (Version Control)
- âœ… Development Tools

### ğŸ’° Cost Information

**Memory-Optimized 32GB Droplet:**
- Monthly: $250/month
- Hourly: $0.347/hour

### ğŸ“ Checklist

- [ ] SSH connection successful
- [ ] Installation logs reviewed
- [ ] Services running (docker ps)
- [ ] KASM web interface accessible

### ğŸ—‘ï¸ Cleanup

When finished, delete the server:
\`\`\`
GitHub Actions â†’ Delete Development Server
Select: yes
Run workflow
\`\`\`

---

âœ¨ Your development server is ready! ğŸš€
SUMMARY
      
      - name: 'âŒ Failure Report'
        id: failure_report
        if: failure()
        run: |
          cat > $GITHUB_STEP_SUMMARY << 'SUMMARY'
## âŒ Server Creation Failed

### ğŸ” Troubleshooting Steps

#### 1ï¸âƒ£ Check Secrets Configuration

Go to: **Settings â†’ Secrets and variables â†’ Actions**

Verify both secrets exist:
- [ ] `DO_API_TOKEN`
- [ ] `SSH_KEY_NAME`

#### 2ï¸âƒ£ Verify DigitalOcean API Token

Your API token needs these permissions:
- âœ… read (read account data)
- âœ… write (create and manage droplets)

Get it from: https://cloud.digitalocean.com/account/api/tokens

#### 3ï¸âƒ£ Check SSH Key in DigitalOcean

Go to: https://cloud.digitalocean.com/account/security

Verify the SSH key name matches your `SSH_KEY_NAME` secret (case-sensitive)

#### 4ï¸âƒ£ Check Account Status

- [ ] Billing is active
- [ ] No resource quotas exceeded
- [ ] Droplet creation is allowed

#### 5ï¸âƒ£ Review Workflow Logs

Click each failed step above to see detailed error messages.

### ğŸ“š Documentation

For more help, see:
- [Setup Guide](../../blob/main/SETUP.md)
- [Troubleshooting](../../blob/main/TROUBLESHOOTING.md)
- [Implementation Guide](../../blob/main/IMPLEMENTATION-GUIDE.md)

### ğŸ”§ Manual Testing

Test your credentials locally:
\`\`\`bash
DO_API_TOKEN="your_token_here"
SSH_KEY_NAME="your_key_name"

# Test API
curl -H "Authorization: Bearer $DO_API_TOKEN" \\
  https://api.digitalocean.com/v2/account

# List SSH keys
curl -H "Authorization: Bearer $DO_API_TOKEN" \\
  https://api.digitalocean.com/v2/account/keys | jq
\`\`\`

---

ğŸ“ Check the logs above for specific error details.
SUMMARY
      
      - name: 'â° Calculate Duration'
        id: duration
        if: always()
        run: |
          END_EPOCH=$(date +%s)
          START_EPOCH=${{ steps.timestamp.outputs.START_EPOCH }}
          DURATION=$((END_EPOCH - START_EPOCH))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))
          
          echo "duration=${MINUTES}m ${SECONDS}s" >> $GITHUB_OUTPUT
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "â±ï¸  WORKFLOW COMPLETED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Duration: ${MINUTES}m ${SECONDS}s"
          echo "Status: ${{ job.status }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
