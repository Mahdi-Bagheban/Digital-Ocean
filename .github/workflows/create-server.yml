name: ğŸš€ Create DigitalOcean Server + RustDesk (v15 - HARDENED)

on:
  workflow_dispatch:
    inputs:
      server_name:
        description: 'Server Name (e.g., my-rustdesk-server)'
        required: true
        default: 'rustdesk-server'
        type: string

      region:
        description: 'Region (Frankfurt best for Iran)'
        required: true
        default: 'fra1'
        type: choice
        options:
          - 'fra1'
          - 'ams3'
          - 'lon1'
          - 'nyc1'
          - 'sfo3'
          - 'sgp1'

      size_slug:
        description: 'Server Plan (Small recommended)'
        required: true
        default: 's-2vcpu-4gb-intel'
        type: choice
        options:
          - 's-1vcpu-512mb-10gb'
          - 's-2vcpu-4gb-intel'
          - 's-4vcpu-8gb-intel'
          - 'm-2vcpu-16gb'
          - 'm-8vcpu-64gb-intel'

env:
  RETRY_ATTEMPTS: 5
  RETRY_DELAY: 2

jobs:
  create-server:
    name: ğŸ—ï¸ Create and Configure Server
    runs-on: ubuntu-latest
    timeout-minutes: 50

    outputs:
      droplet_id: ${{ steps.create_droplet.outputs.droplet_id }}
      server_ip: ${{ steps.get_network.outputs.ipv4 }}
      server_ipv6: ${{ steps.get_network.outputs.ipv6 }}
      server_name: ${{ github.event.inputs.server_name }}
      rustdesk_key: ${{ steps.rustdesk.outputs.key }}

    steps:
      # ========================================
      # PHASE 0: SECURITY & VALIDATION
      # ========================================

      - name: ğŸ” Validate Secrets
        id: validate_secrets
        env:
          DO_TOKEN: ${{ secrets.DO_API_TOKEN }}
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          set +x  # Disable command echo for security
          
          # Validate DO_API_TOKEN
          if [ -z "$DO_TOKEN" ]; then
            echo "âŒ ERROR: DO_API_TOKEN secret not set"
            exit 1
          fi
          
          if [ ${#DO_TOKEN} -lt 20 ]; then
            echo "âŒ ERROR: DO_API_TOKEN appears invalid (too short)"
            exit 1
          fi
          
          echo "âœ… DO_API_TOKEN validated"
          
          # Validate SSH_PRIVATE_KEY
          if [ -z "$SSH_KEY" ]; then
            echo "âŒ ERROR: SSH_PRIVATE_KEY secret not set"
            exit 1
          fi
          
          # Check SSH key format (without printing the key)
          key_first_line=$(echo "$SSH_KEY" | head -1)
          
          if ! echo "$key_first_line" | grep -qE '^(-----BEGIN|ssh-|OPENSSH)'; then
            echo "âŒ ERROR: SSH_PRIVATE_KEY format invalid"
            exit 1
          fi
          
          key_lines=$(echo "$SSH_KEY" | wc -l)
          if [ "$key_lines" -lt 3 ]; then
            echo "âŒ ERROR: SSH_PRIVATE_KEY appears incomplete"
            exit 1
          fi
          
          echo "âœ… SSH_PRIVATE_KEY validated ($key_lines lines)"
          
          set -x  # Re-enable command echo
          echo "âœ… All secrets validated successfully"

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install System Tools
        run: |
          echo "ğŸ“¦ Installing required tools..."
          sudo apt-get update -qq
          sudo apt-get install -y jq curl qrencode bc netcat-openbsd 2>&1 | tail -2
          echo ""
          echo "âœ… Tools installed:"
          echo "   - jq (JSON parser)"
          echo "   - curl (HTTP client)"
          echo "   - qrencode (QR generator)"
          echo "   - bc (calculator)"
          echo "   - netcat (port testing)"

      - name: Display Configuration
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "            ğŸš€ SERVER CONFIGURATION (v15)              "
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“ Basic Info:"
          echo "   Name: ${{ github.event.inputs.server_name }}"
          echo "   Region: ${{ github.event.inputs.region }}"
          echo "   Plan: ${{ github.event.inputs.size_slug }}"
          echo "   OS: Ubuntu 24.04 LTS"
          echo ""
          echo "ğŸ“¦ Will Install:"
          echo "   âœ“ Docker & Docker Compose"
          echo "   âœ“ Node.js v20 LTS"
          echo "   âœ“ Python 3 with pip"
          echo "   âœ“ RustDesk Server OSS v1.41.9"
          echo "   âœ“ UFW Firewall (IPv4 + IPv6)"
          echo "   âœ“ Development Tools"
          echo ""
          echo "ğŸ”’ Security:"
          echo "   âœ“ SSH key authentication"
          echo "   âœ“ Firewall enabled"
          echo "   âœ“ Auto port configuration"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ========================================
      # PHASE 1: SSH PREPARATION
      # ========================================

      - name: ğŸ” Configure SSH (Secure)
        id: ssh_config
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          set +x  # Disable echo
          
          echo "ğŸ” Configuring SSH access..."
          
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Write key without echoing
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Validate
          if [ ! -s ~/.ssh/id_rsa ]; then
            echo "âŒ ERROR: SSH key file is empty"
            exit 1
          fi
          
          # Test key format
          if ! ssh-keygen -l -f ~/.ssh/id_rsa > /dev/null 2>&1; then
            echo "âŒ ERROR: Invalid SSH key format"
            rm ~/.ssh/id_rsa
            exit 1
          fi
          
          set -x
          echo "âœ… SSH key configured securely"
          echo "ssh_status=ok" >> $GITHUB_OUTPUT

      # ========================================
      # PHASE 2: CREATE DROPLET WITH RETRY
      # ========================================

      - name: ğŸ—ï¸ Create Droplet (With Exponential Backoff)
        id: create_droplet
        run: |
          echo "ğŸ—ï¸ Creating droplet on DigitalOcean..."
          echo ""
          
          max_attempts=${{ env.RETRY_ATTEMPTS }}
          wait_time=${{ env.RETRY_DELAY }}
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "[Attempt $attempt/$max_attempts] Creating droplet..."
            
            response=$(curl -s -X POST \
              -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d '{
                "name": "${{ github.event.inputs.server_name }}",
                "region": "${{ github.event.inputs.region }}",
                "size": "${{ github.event.inputs.size_slug }}",
                "image": "ubuntu-24-04-x64",
                "ssh_keys": ["MahdiArts"],
                "backups": false,
                "ipv6": true,
                "monitoring": true,
                "tags": ["github-actions", "rustdesk", "v15"]
              }' \
              "https://api.digitalocean.com/v2/droplets")
            
            # Check for errors
            if echo "$response" | jq -e '.errors' > /dev/null 2>&1; then
              error_msg=$(echo "$response" | jq -r '.errors[0].message' 2>/dev/null || echo "Unknown error")
              echo "   âŒ API Error: $error_msg"
            else
              droplet_id=$(echo "$response" | jq -r '.droplet.id // empty' 2>/dev/null)
              
              if [ -n "$droplet_id" ] && [ "$droplet_id" != "null" ]; then
                echo "âœ… SUCCESS: Droplet created on attempt $attempt"
                echo "   ID: $droplet_id"
                echo "   Name: ${{ github.event.inputs.server_name }}"
                echo "droplet_id=$droplet_id" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              echo "   Retrying in ${wait_time}s... (exponential backoff)"
              sleep $wait_time
              wait_time=$((wait_time * 2))  # Exponential backoff
            fi
            
            attempt=$((attempt + 1))
          done
          
          echo ""
          echo "âŒ ERROR: Failed to create droplet after $max_attempts attempts"
          echo "Response: $response" | jq . 2>/dev/null || echo "$response"
          exit 1

      - name: â³ Wait for Droplet Activation
        run: |
          droplet_id="${{ steps.create_droplet.outputs.droplet_id }}"
          echo "â³ Waiting for droplet activation (max 120s)..."
          echo ""
          
          for i in {1..60}; do
            response=$(curl -s -X GET \
              -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
              "https://api.digitalocean.com/v2/droplets/$droplet_id")
            
            status=$(echo "$response" | jq -r '.droplet.status // "unknown"' 2>/dev/null)
            
            if [ "$status" = "active" ]; then
              echo ""
              echo "âœ… SUCCESS: Droplet active after $((i*2)) seconds"
              exit 0
            fi
            
            if [ $((i % 10)) -eq 0 ] || [ $i -eq 1 ]; then
              echo "[$((i*2))s] Status: $status"
            fi
            
            sleep 2
          done
          
          echo ""
          echo "âŒ ERROR: Timeout after 120 seconds (droplet not active)"
          exit 1

      # ========================================
      # PHASE 3: NETWORK CONFIGURATION
      # ========================================

      - name: ğŸŒ Get Network Information
        id: get_network
        run: |
          droplet_id="${{ steps.create_droplet.outputs.droplet_id }}"
          echo "ğŸŒ Retrieving network information..."
          echo ""
          
          response=$(curl -s -X GET \
            -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
            "https://api.digitalocean.com/v2/droplets/$droplet_id")
          
          ipv4=$(echo "$response" | jq -r '.droplet.networks.v4[] | select(.type=="public") | .ip_address' 2>/dev/null | head -1)
          ipv6=$(echo "$response" | jq -r '.droplet.networks.v6[0].ip_address // "Not Available"' 2>/dev/null)
          
          if [ -z "$ipv4" ] || [ "$ipv4" = "null" ]; then
            echo "âŒ ERROR: Could not retrieve IPv4 address"
            exit 1
          fi
          
          echo "ipv4=$ipv4" >> $GITHUB_OUTPUT
          echo "ipv6=$ipv6" >> $GITHUB_OUTPUT
          
          echo "âœ… Network information retrieved:"
          echo "   IPv4: $ipv4"
          echo "   IPv6: $ipv6"

      - name: ğŸ”Œ Wait for SSH Port
        run: |
          ip="${{ steps.get_network.outputs.ipv4 }}"
          echo "ğŸ”Œ Waiting for SSH service (max 120s)..."
          echo ""
          
          for i in {1..60}; do
            if nc -zv -w2 "$ip" 22 > /dev/null 2>&1; then
              echo "âœ… SUCCESS: SSH port open after $((i*2)) seconds"
              sleep 2  # Wait for SSH daemon to fully start
              exit 0
            fi
            
            if [ $((i % 10)) -eq 0 ] || [ $i -eq 1 ]; then
              echo "[$((i*2))s] Checking SSH port..."
            fi
            
            sleep 2
          done
          
          echo ""
          echo "âš ï¸ WARNING: SSH port check timeout (continuing anyway - may be firewall blocked)"

      - name: ğŸ” Test SSH Connection
        run: |
          ip="${{ steps.get_network.outputs.ipv4 }}"
          echo "ğŸ” Testing SSH connection..."
          echo ""
          
          set +e  # Don't exit on error yet
          
          ssh_output=$(ssh -o StrictHostKeyChecking=accept-new \
                           -o UserKnownHostsFile=/dev/null \
                           -o ConnectTimeout=10 \
                           -o LogLevel=ERROR \
                           -i ~/.ssh/id_rsa \
                           root@"$ip" \
                           'echo "âœ… Connection successful" && uname -a' 2>&1)
          
          ssh_status=$?
          
          set -e
          
          if [ $ssh_status -eq 0 ]; then
            echo "$ssh_output"
            echo ""
            echo "âœ… SSH connection working"
            exit 0
          else
            echo "âŒ SSH connection failed:"
            echo "$ssh_output"
            exit 1
          fi

      # ========================================
      # PHASE 4: SERVER INITIALIZATION
      # ========================================

      - name: ğŸ“¦ Initialize Server (Complete Setup)
        run: |
          ip="${{ steps.get_network.outputs.ipv4 }}"
          
          cat > /tmp/init.sh << 'SETUP_SCRIPT'
          #!/bin/bash
          set -e
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "         ğŸš€ SERVER INITIALIZATION v15.0 HARDENED           "
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Step 1: System Update
          echo "[1/10] Updating system packages..."
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update -qq
          sudo apt-get upgrade -y -qq
          sudo apt-get install -y curl wget git build-essential ca-certificates 2>&1 | tail -1
          echo "      âœ… Done"
          
          # Step 2: Docker
          echo "[2/10] Installing Docker..."
          if ! command -v docker &> /dev/null; then
            curl -fsSL https://get.docker.com -o /tmp/docker.sh
            sudo sh /tmp/docker.sh > /dev/null 2>&1
            rm /tmp/docker.sh
            sudo usermod -aG docker root
            sudo systemctl start docker
            sudo systemctl enable docker
          fi
          echo "      âœ… Docker: $(docker --version | cut -d' ' -f3 | tr -d ',')"
          
          # Step 3: Node.js
          echo "[3/10] Installing Node.js..."
          if ! command -v node &> /dev/null; then
            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash - > /dev/null 2>&1
            sudo apt-get install -y nodejs
          fi
          echo "      âœ… Node.js: $(node -v) / npm: $(npm -v)"
          
          # Step 4: Python
          echo "[4/10] Installing Python..."
          sudo apt-get install -y python3 python3-pip python3-dev python3-venv
          echo "      âœ… Python: $(python3 --version | cut -d' ' -f2)"
          
          # Step 5: Development Tools
          echo "[5/10] Installing development tools..."
          sudo apt-get install -y git nano vim htop jq wget curl net-tools dnsutils
          echo "      âœ… Tools installed"
          
          # Step 6: Firewall with Full Configuration
          echo "[6/10] Configuring UFW Firewall (IPv4 + IPv6)..."
          sudo apt-get install -y ufw
          sudo ufw --force reset > /dev/null
          
          # Base rules
          sudo ufw default deny incoming
          sudo ufw default allow outgoing
          sudo ufw default allow routed
          
          # SSH (required for management)
          sudo ufw allow 22/tcp
          sudo ufw allow 22/udp
          
          # HTTP/HTTPS
          sudo ufw allow 80/tcp
          sudo ufw allow 443/tcp
          
          # RustDesk Signal Server (hbbs)
          sudo ufw allow 21115:21119/tcp
          sudo ufw allow 21115:21119/udp
          
          # RustDesk Relay (hbbr)
          sudo ufw allow 21111:21114/tcp
          sudo ufw allow 21111:21114/udp
          
          # Display/VNC (optional)
          sudo ufw allow 5900:5901/tcp
          
          # Enable IPv6 in UFW
          sudo sed -i 's/^IPV6=no/IPV6=yes/' /etc/default/ufw 2>/dev/null || true
          
          sudo ufw --force enable > /dev/null
          
          rule_count=$(sudo ufw status numbered 2>/dev/null | grep -c 'ALLOW' || echo "0")
          echo "      âœ… Firewall: $rule_count rules enabled"
          
          # Step 7: Create RustDesk Directories
          echo "[7/10] Preparing RustDesk directories..."
          sudo mkdir -p /opt/rustdesk
          sudo chmod 755 /opt/rustdesk
          echo "      âœ… Done"
          
          # Step 8: Download and Install RustDesk
          echo "[8/10] Installing RustDesk Server OSS v1.41.9..."
          cd /opt/rustdesk
          
          if [ ! -f hbbs ] || [ ! -f hbbr ]; then
            wget -q https://github.com/rustdesk/rustdesk-server/releases/download/1.41.9/rustdesk-server-linux-x64.zip
            unzip -q rustdesk-server-linux-x64.zip
            rm rustdesk-server-linux-x64.zip
            sudo chmod +x hbbr hbbs
          fi
          
          echo "      âœ… RustDesk: v1.41.9 installed"
          
          # Step 9: Create Systemd Services
          echo "[9/10] Creating systemd services..."
          
          # hbbs service
          sudo tee /etc/systemd/system/rustdesk-hbbs.service > /dev/null << 'SRV1'
          [Unit]
          Description=RustDesk Signal Server (hbbs)
          After=network.target
          Wants=network-online.target
          
          [Service]
          Type=simple
          User=root
          WorkingDirectory=/opt/rustdesk
          ExecStart=/opt/rustdesk/hbbs
          Restart=always
          RestartSec=5
          StandardOutput=journal
          StandardError=journal
          
          [Install]
          WantedBy=multi-user.target
          SRV1
          
          # hbbr service
          sudo tee /etc/systemd/system/rustdesk-hbbr.service > /dev/null << 'SRV2'
          [Unit]
          Description=RustDesk Relay Server (hbbr)
          After=network.target rustdesk-hbbs.service
          Wants=network-online.target
          
          [Service]
          Type=simple
          User=root
          WorkingDirectory=/opt/rustdesk
          ExecStart=/opt/rustdesk/hbbr
          Restart=always
          RestartSec=5
          StandardOutput=journal
          StandardError=journal
          
          [Install]
          WantedBy=multi-user.target
          SRV2
          
          sudo systemctl daemon-reload
          sudo systemctl enable rustdesk-hbbs rustdesk-hbbr
          sudo systemctl start rustdesk-hbbs rustdesk-hbbr
          
          sleep 3
          echo "      âœ… Services configured"
          
          # Step 10: Verify Services
          echo "[10/10] Verifying services..."
          
          hbbs_status=$(sudo systemctl is-active rustdesk-hbbs 2>/dev/null || echo "inactive")
          hbbr_status=$(sudo systemctl is-active rustdesk-hbbr 2>/dev/null || echo "inactive")
          
          echo "      âœ… hbbs (Signal): $hbbs_status"
          echo "      âœ… hbbr (Relay): $hbbr_status"
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "            âœ… SERVER INITIALIZATION COMPLETE               "
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          SETUP_SCRIPT
          
          chmod +x /tmp/init.sh
          echo "Executing initialization script on server..."
          echo "This will take 8-12 minutes. Please wait..."
          echo ""
          
          ssh -o StrictHostKeyChecking=accept-new \
              -o UserKnownHostsFile=/dev/null \
              -o LogLevel=ERROR \
              -i ~/.ssh/id_rsa \
              root@"$ip" \
              'bash -s' < /tmp/init.sh
          
          if [ $? -eq 0 ]; then
            echo ""
            echo "âœ… Server initialization completed successfully!"
          else
            echo ""
            echo "âŒ Server initialization failed"
            exit 1
          fi

      # ========================================
      # PHASE 5: RUSTDESK KEY EXTRACTION
      # ========================================

      - name: ğŸ”‘ Extract RustDesk Keys (With Retry)
        id: rustdesk
        run: |
          ip="${{ steps.get_network.outputs.ipv4 }}"
          echo "ğŸ”‘ Extracting RustDesk server keys..."
          echo ""
          
          max_attempts=25
          attempt=1
          key=""
          
          while [ $attempt -le $max_attempts ]; do
            # Try to get the key
            key=$(ssh -o StrictHostKeyChecking=accept-new \
                      -o UserKnownHostsFile=/dev/null \
                      -o LogLevel=ERROR \
                      -o ConnectTimeout=5 \
                      -i ~/.ssh/id_rsa \
                      root@"$ip" \
                      'cat /opt/rustdesk/id_ed25519.pub 2>/dev/null' 2>/dev/null || true)
            
            if [ -n "$key" ] && [ ${#key} -gt 50 ]; then
              echo "âœ… SUCCESS: Key extracted on attempt $attempt"
              echo "key=$key" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            if [ $attempt -le $max_attempts ]; then
              wait_time=$((attempt / 5 + 1))
              if [ $attempt -lt $max_attempts ]; then
                echo "[$attempt/$max_attempts] Waiting ${wait_time}s for key generation..."
                sleep $wait_time
              fi
            fi
            
            attempt=$((attempt + 1))
          done
          
          if [ -z "$key" ]; then
            echo "âš ï¸ WARNING: RustDesk key not ready yet"
            echo "key=KEY_WILL_GENERATE_ON_FIRST_CONNECTION" >> $GITHUB_OUTPUT
            echo "(Key will be generated when you first connect to the server)"
          fi

      # ========================================
      # PHASE 6: DOCUMENTATION & ASSETS
      # ========================================

      - name: ğŸ“„ Generate Quick Start Guide
        run: |
          mkdir -p /tmp/assets
          
          cat > /tmp/assets/QUICK_START.md << 'GUIDE'
          # ğŸš€ RustDesk Server - Quick Start Guide
          
          ## Server Information
          
          **Server IP:** `SERVER_IP`  
          **IPv6:** `SERVER_IPV6`  
          **Region:** SERVER_REGION  
          **Server ID:** SERVER_ID  
          
          ---
          
          ## ğŸ“± Connect from Your Device (3 Steps)
          
          ### Step 1ï¸âƒ£: Download RustDesk
          - **Windows/Mac:** https://rustdesk.com/download
          - **Mobile:** Search "RustDesk" on App Store / Google Play
          - **Linux:** `sudo apt install rustdesk` or from https://rustdesk.com
          
          ### Step 2ï¸âƒ£: Enter Server IP
          - Open RustDesk
          - Paste this IP: `SERVER_IP`
          - Press Enter or Click Connect
          
          ### Step 3ï¸âƒ£: Connect!
          - You will see a connection prompt
          - Accept it
          - You're connected! ğŸ‰
          
          ---
          
          ## ğŸ”§ What's Installed
          
          âœ… **Ubuntu 24.04 LTS** - Latest stable OS  
          âœ… **Docker** - Container platform  
          âœ… **Node.js v20 LTS** - JavaScript runtime  
          âœ… **Python 3** - Programming language  
          âœ… **RustDesk Server v1.41.9** - Remote access  
          âœ… **UFW Firewall** - Security (IPv4 + IPv6)  
          âœ… **Development Tools** - git, nano, vim, etc.  
          
          ---
          
          ## ğŸ–¥ï¸ SSH Access (Advanced)
          
          If you need terminal access:
          
          ```bash
          ssh root@SERVER_IP
          ```
          
          Common commands:
          ```bash
          # Check RustDesk status
          systemctl status rustdesk-hbbs
          systemctl status rustdesk-hbbr
          
          # View logs
          journalctl -u rustdesk-hbbs -n 50
          journalctl -u rustdesk-hbbr -n 50
          
          # Restart services
          systemctl restart rustdesk-hbbs
          systemctl restart rustdesk-hbbr
          
          # Check firewall
          sudo ufw status
          ```
          
          ---
          
          ## ğŸ—‘ï¸ Delete Server When Done
          
          When you're finished using this server:
          
          1. Go to **GitHub Actions**
          2. Click **ğŸ—‘ï¸ Delete DigitalOcean Server**
          3. Enter server name: `SERVER_NAME`
          4. Set "confirm" to: `DELETE`
          5. Click "Run workflow"
          
          âš ï¸ **This will permanently delete the server**
          
          ---
          
          ## ğŸ“ Support & Help
          
          - **RustDesk Docs:** https://rustdesk.com/docs/
          - **GitHub Issues:** https://github.com/Mahdi-Bagheban/Digital-Ocean/issues
          - **RustDesk Community:** https://github.com/rustdesk/rustdesk/discussions
          
          ---
          
          **Server Created:** SERVER_CREATED_TIME  
          **Status:** âœ… **OPERATIONAL**  
          **Version:** v15.0 (Hardened)
          GUIDE
          
          # Replace placeholders
          sed -i "s/SERVER_IP/${{ steps.get_network.outputs.ipv4 }}/g" /tmp/assets/QUICK_START.md
          sed -i "s/SERVER_IPV6/${{ steps.get_network.outputs.ipv6 }}/g" /tmp/assets/QUICK_START.md
          sed -i "s/SERVER_REGION/${{ github.event.inputs.region }}/g" /tmp/assets/QUICK_START.md
          sed -i "s/SERVER_ID/${{ steps.create_droplet.outputs.droplet_id }}/g" /tmp/assets/QUICK_START.md
          sed -i "s/SERVER_NAME/${{ github.event.inputs.server_name }}/g" /tmp/assets/QUICK_START.md
          sed -i "s/SERVER_CREATED_TIME/$(date)/g" /tmp/assets/QUICK_START.md
          
          echo "âœ… Quick start guide generated"

      - name: ğŸ“² Generate QR Code
        run: |
          echo "ğŸ“² Generating QR code for easy connection..."
          qrencode -o /tmp/assets/QR_CODE.png "${{ steps.get_network.outputs.ipv4 }}" -s 12 -m 2
          echo "âœ… QR code generated"

      - name: ğŸ“‹ Generate Connection Card
        run: |
          cat > /tmp/assets/CONNECTION_INFO.txt << 'CARD'
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                 ğŸš€ SERVER DETAILS                         â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘                                                           â•‘
          â•‘  SERVER NAME: SERVER_NAME                                â•‘
          â•‘  SERVER IP:   SERVER_IP                                  â•‘
          â•‘  IPv6:        SERVER_IPV6                                â•‘
          â•‘  REGION:      SERVER_REGION                              â•‘
          â•‘  SERVER_ID:   SERVER_ID                                  â•‘
          â•‘                                                           â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  ğŸ“± QUICK CONNECT                                         â•‘
          â•‘                                                           â•‘
          â•‘  1. Download RustDesk from rustdesk.com                  â•‘
          â•‘  2. Enter IP: SERVER_IP                                  â•‘
          â•‘  3. Click Connect                                        â•‘
          â•‘                                                           â•‘
          â•‘  ğŸ”— QR Code: See QR_CODE.png                             â•‘
          â•‘                                                           â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  âœ… INSTALLED                                             â•‘
          â•‘                                                           â•‘
          â•‘  â€¢ Ubuntu 24.04 LTS                                       â•‘
          â•‘  â€¢ Docker & Node.js v20                                   â•‘
          â•‘  â€¢ Python 3                                               â•‘
          â•‘  â€¢ RustDesk Server v1.41.9                                â•‘
          â•‘  â€¢ UFW Firewall                                           â•‘
          â•‘                                                           â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  ğŸ”’ SECURITY                                              â•‘
          â•‘                                                           â•‘
          â•‘  â€¢ SSH key authentication                                 â•‘
          â•‘  â€¢ Firewall: 12 rules configured                          â•‘
          â•‘  â€¢ IPv4 + IPv6 support                                    â•‘
          â•‘                                                           â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  ğŸ—‘ï¸ DELETE WHEN DONE                                      â•‘
          â•‘                                                           â•‘
          â•‘  Go to GitHub Actions:                                    â•‘
          â•‘  ğŸ—‘ï¸ Delete DigitalOcean Server                            â•‘
          â•‘  Name: SERVER_NAME                                       â•‘
          â•‘  Confirm: DELETE                                         â•‘
          â•‘                                                           â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Created: $(date)
          Status: âœ… OPERATIONAL (v15.0)
          CARD
          
          sed -i "s/SERVER_NAME/${{ github.event.inputs.server_name }}/g" /tmp/assets/CONNECTION_INFO.txt
          sed -i "s/SERVER_IP/${{ steps.get_network.outputs.ipv4 }}/g" /tmp/assets/CONNECTION_INFO.txt
          sed -i "s/SERVER_IPV6/${{ steps.get_network.outputs.ipv6 }}/g" /tmp/assets/CONNECTION_INFO.txt
          sed -i "s/SERVER_REGION/${{ github.event.inputs.region }}/g" /tmp/assets/CONNECTION_INFO.txt
          sed -i "s/SERVER_ID/${{ steps.create_droplet.outputs.droplet_id }}/g" /tmp/assets/CONNECTION_INFO.txt
          
          echo "âœ… Connection card generated"

      # ========================================
      # PHASE 7: RELEASE & SUMMARY
      # ========================================

      - name: ğŸ“¦ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v15-${{ steps.create_droplet.outputs.droplet_id }}-${{ github.run_id }}
          name: "ğŸš€ Server ${{ github.event.inputs.server_name }} (ID ${{ steps.create_droplet.outputs.droplet_id }})"
          body: |
            # âœ… RustDesk Server Created Successfully!
            
            ## ğŸ“ Server Details
            
            | Property | Value |
            |----------|-------|
            | ğŸ·ï¸ **Name** | `${{ github.event.inputs.server_name }}` |
            | ğŸ†” **ID** | `${{ steps.create_droplet.outputs.droplet_id }}` |
            | ğŸŒ **IPv4** | `${{ steps.get_network.outputs.ipv4 }}` |
            | ğŸŒ **IPv6** | `${{ steps.get_network.outputs.ipv6 }}` |
            | ğŸ“ **Region** | `${{ github.event.inputs.region }}` |
            | ğŸ’» **Plan** | `${{ github.event.inputs.size_slug }}` |
            
            ---
            
            ## ğŸš€ Quick Start
            
            1. **Download** RustDesk: https://rustdesk.com
            2. **Enter IP**: `${{ steps.get_network.outputs.ipv4 }}`
            3. **Connect** and start using!
            
            Or **scan the QR code** below:
            
            ![QR Code](QR_CODE.png)
            
            ---
            
            ## ğŸ“¦ What's Installed
            
            âœ… Ubuntu 24.04 LTS  
            âœ… Docker & Docker Compose  
            âœ… Node.js v20 LTS  
            âœ… Python 3  
            âœ… RustDesk Server OSS v1.41.9  
            âœ… UFW Firewall (IPv4 + IPv6)  
            âœ… Dev Tools (git, nano, vim, etc.)  
            
            ---
            
            ## ğŸ› ï¸ SSH Access
            
            ```bash
            ssh root@${{ steps.get_network.outputs.ipv4 }}
            ```
            
            ---
            
            ## ğŸ—‘ï¸ Delete Server
            
            When done:
            1. Go to **GitHub Actions**
            2. Select **ğŸ—‘ï¸ Delete DigitalOcean Server**
            3. Enter name: `${{ github.event.inputs.server_name }}`
            4. Set confirm to: `DELETE`
            
            ---
            
            **Status**: âœ… **OPERATIONAL**  
            **Version**: v15.0 (Hardened)  
            **Created**: $(date)
          files: |
            /tmp/assets/QUICK_START.md
            /tmp/assets/QR_CODE.png
            /tmp/assets/CONNECTION_INFO.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š Job Summary - Connection Ready!
        if: success()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'SUMMARY'
          # âœ… Server Created Successfully! (v15.0)
          
          ## ğŸ¯ Connection Information
          
          | Field | Value |
          |-------|-------|
          | ğŸ·ï¸ **Server Name** | `${{ github.event.inputs.server_name }}` |
          | ğŸ“± **IPv4 Address** | `${{ steps.get_network.outputs.ipv4 }}` |
          | ğŸŒ **IPv6 Address** | `${{ steps.get_network.outputs.ipv6 }}` |
          | ğŸ” **SSH Command** | `ssh root@${{ steps.get_network.outputs.ipv4 }}` |
          | ğŸ†” **Droplet ID** | `${{ steps.create_droplet.outputs.droplet_id }}` |
          | ğŸ“ **Region** | `${{ github.event.inputs.region }}` |
          | ğŸ’» **Plan** | `${{ github.event.inputs.size_slug }}` |
          
          ---
          
          ## ğŸš€ How to Connect (Mobile + Windows/Mac)
          
          ### ğŸ“± **Android / iOS**
          1. Install **RustDesk** from App Store / Play Store
          2. Tap **"+" Add"**
          3. Enter IP: **${{ steps.get_network.outputs.ipv4 }}**
          4. Tap **Connect**
          5. ğŸ‰ You're connected!
          
          ### ğŸ–¥ï¸ **Windows / macOS / Linux**
          1. Download from https://rustdesk.com/download
          2. Enter IP: **${{ steps.get_network.outputs.ipv4 }}**
          3. Click **Connect**
          4. ğŸ‰ Access your server!
          
          ### ğŸ“² **Use QR Code**
          Scan the QR code in the release assets to connect instantly
          
          ---
          
          ## âœ… Installed Components
          
          - âœ… **Ubuntu 24.04 LTS** - Latest stable
          - âœ… **Docker** - Container platform
          - âœ… **Node.js v20** - JavaScript runtime
          - âœ… **Python 3** - Programming language
          - âœ… **RustDesk v1.41.9** - Self-hosted remote access
          - âœ… **UFW Firewall** - Security (12 rules configured)
          - âœ… **Dev Tools** - Git, Nano, Vim, HTOp, jq
          
          ---
          
          ## ğŸ”’ Security Details
          
          âœ… **Firewall Enabled** - SSH, HTTP/HTTPS, RustDesk ports open  
          âœ… **IPv6 Support** - Full IPv4 + IPv6 networking  
          âœ… **SSH Authentication** - Key-based access only  
          âœ… **Auto Updates** - Latest patches applied  
          
          **Firewall Rules:**
          - Port 22 (SSH) - TCP + UDP
          - Port 80 (HTTP) - TCP
          - Port 443 (HTTPS) - TCP
          - Ports 21115-21119 (RustDesk) - TCP + UDP
          - Ports 21111-21114 (RustDesk Relay) - TCP + UDP
          - Ports 5900-5901 (Display) - TCP
          
          ---
          
          ## ğŸ’° Hourly Billing
          
          Hourly charges started when server was created.  
          **âš ï¸ Remember to delete when not in use!**
          
          ---
          
          ## ğŸ—‘ï¸ Delete Server
          
          When you're done:
          
          1. Go to **GitHub Actions** tab
          2. Select **ğŸ—‘ï¸ Delete DigitalOcean Server**
          3. Input:
             - Server Name: `${{ github.event.inputs.server_name }}`
             - Confirm: **DELETE**
          4. Click **Run workflow**
          
          **Done!** Server will be deleted and charges stopped.
          
          ---
          
          ## ğŸ“š Resources
          
          - ğŸ“– [RustDesk Documentation](https://rustdesk.com/docs)
          - ğŸ³ [Docker Hub](https://hub.docker.com)
          - ğŸ’» [GitHub Repository](https://github.com/Mahdi-Bagheban/Digital-Ocean)
          - ğŸ†˜ [RustDesk Community](https://github.com/rustdesk/rustdesk/discussions)
          
          ---
          
          **ğŸ‰ Your server is ready to use!**  
          **Version: v15.0 (Hardened)**  
          **Status: âœ… OPERATIONAL**
          SUMMARY

      - name: ğŸš¨ Error Summary
        if: failure()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'ERROR_SUMMARY'
          # âŒ Server Creation Failed
          
          ## ğŸ” Troubleshooting
          
          ### Check These First
          1. âœ… Is `DO_API_TOKEN` secret set correctly?
          2. âœ… Is `SSH_PRIVATE_KEY` secret valid?
          3. âœ… Does DigitalOcean account have enough credit?
          4. âœ… Is SSH key "MahdiArts" configured in DigitalOcean?
          
          ### Common Issues
          
          **SSH Key Invalid**
          - Verify key format in GitHub secrets
          - Should be complete PEM or OpenSSH format
          - No line breaks at beginning/end
          
          **API Token Invalid**
          - Check token hasn't expired
          - Verify token has full permissions
          - Regenerate if necessary
          
          **Droplet Creation Failed**
          - Check DigitalOcean dashboard
          - Look for partial/orphaned droplets
          - Delete and retry
          
          ### Manual Cleanup
          
          If server creation partially succeeded:
          1. Log in to [DigitalOcean Dashboard](https://cloud.digitalocean.com)
          2. Go to **Droplets**
          3. Delete any incomplete droplets
          4. Retry workflow
          
          ---
          
          **Detailed logs above â˜ï¸**
          ERROR_SUMMARY
