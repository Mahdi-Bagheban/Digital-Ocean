name: ðŸš€ Create Development Server with KASM

on:
  workflow_dispatch:
    inputs:
      server_name:
        description: 'ðŸ’» Server Name (Ù†Ø§Ù… Ø³Ø±ÙˆØ±)'
        required: false
        default: 'mahdi-dev-workspace'
        type: string
      region:
        description: 'ðŸ—ºï¸ Datacenter Region (Ù…Ù†Ø·Ù‚Ù‡ Ø¯ÛŒØªØ§Ø³Ù†ØªØ±)'
        required: false
        default: 'fra1'
        type: choice
        options:
          - fra1
          - ams3
          - lon1
          - nyc1

jobs:
  create-server:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸ”§ Install Dependencies
        run: |
          set -e
          echo "ðŸ“¦ Installing system dependencies..."
          sudo apt-get update -qq
          sudo apt-get install -y jq bc curl wget
          echo "âœ… Dependencies installed"
          echo ""
          echo "ðŸ“‹ Version Check:"
          echo "jq: $(jq --version)"
          echo "curl: $(curl --version | head -n 1)"
          echo "bc: $(echo | bc -v 2>&1 | head -n 1)"
      
      - name: ðŸ” Validate Secrets
        run: |
          echo "ðŸ” Validating required secrets..."
          
          if [ -z "${{ secrets.DO_API_TOKEN }}" ]; then
            echo "âŒ ERROR: DO_API_TOKEN is not set"
            echo ""
            echo "ðŸ“ How to fix:"
            echo "1. Go to: https://github.com/Mahdi-Bagheban/Digital-Ocean/settings/secrets/actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: DO_API_TOKEN"
            echo "4. Value: dop_v1_your_api_token_here"
            echo "5. Click 'Add secret'"
            exit 1
          fi
          
          if [ -z "${{ secrets.SSH_KEY_NAME }}" ]; then
            echo "âŒ ERROR: SSH_KEY_NAME is not set"
            echo ""
            echo "ðŸ“ How to fix:"
            echo "1. Go to: https://github.com/Mahdi-Bagheban/Digital-Ocean/settings/secrets/actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: SSH_KEY_NAME"
            echo "4. Value: MahdiArts (or your SSH key name)"
            echo "5. Click 'Add secret'"
            exit 1
          fi
          
          echo "âœ… All required secrets are configured"
      
      - name: ðŸ” Configure Environment
        run: |
          echo "âš™ï¸ Configuring environment..."
          
          cat > .env << 'ENVFILE'
DO_API_TOKEN=${{ secrets.DO_API_TOKEN }}
SSH_KEY_NAME=${{ secrets.SSH_KEY_NAME }}
DROPLET_NAME=${{ github.event.inputs.server_name }}
REGION=${{ github.event.inputs.region }}
ENVFILE
          
          if [ ! -f ".env" ]; then
            echo "âŒ Failed to create .env file"
            exit 1
          fi
          
          echo "âœ… Environment configured"
          echo ""
          echo "ðŸ“‹ Configuration Summary:"
          echo "Server Name: ${{ github.event.inputs.server_name }}"
          echo "Region: ${{ github.event.inputs.region }}"
          echo "SSH Key: ${{ secrets.SSH_KEY_NAME }}"
      
      - name: ðŸš€ Create Server
        id: create_server
        run: |
          set -e
          
          echo "ðŸ”¨ Starting server creation..."
          echo ""
          
          if [ ! -f "create-server.sh" ]; then
            echo "âŒ ERROR: create-server.sh not found"
            echo "ðŸ“ Current directory contents:"
            ls -la
            exit 1
          fi
          
          echo "âœ… create-server.sh found"
          echo "ðŸ”“ Making script executable..."
          chmod +x create-server.sh
          
          echo "âš™ï¸ Executing create-server.sh..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          ./create-server.sh
          RESULT=$?
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          if [ $RESULT -eq 0 ]; then
            echo ""
            echo "âœ… Server creation script completed successfully"
            exit 0
          else
            echo ""
            echo "âŒ Server creation script failed with exit code: $RESULT"
            exit 1
          fi
      
      - name: ðŸ“¤ Save Server Information
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: server-info
          path: |
            .droplet_id
            .droplet_ip
            .droplet_created_at
          retention-days: 7
          if-no-files-found: warn
      
      - name: ðŸ“Š Success Report
        if: success()
        run: |
          echo "## ðŸŽ‰ Ø³Ø±ÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Server Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Ù…ÙˆØ±Ø¯ | Ù…Ù‚Ø¯Ø§Ø± |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Droplet ID** | \`$(cat .droplet_id 2>/dev/null || echo 'N/A')\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Server IP** | \`$(cat .droplet_ip 2>/dev/null || echo 'N/A')\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Server Name** | ${{ github.event.inputs.server_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Region** | ${{ github.event.inputs.region }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Specifications** | 32GB RAM â€¢ 2 vCPU â€¢ 100GB SSD |" >> $GITHUB_STEP_SUMMARY
          echo "| **Operating System** | Ubuntu 22.04 LTS |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Connection Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**SSH Access:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "ssh root@$(cat .droplet_ip 2>/dev/null || echo 'YOUR_SERVER_IP')" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**KASM Workspace Web Interface:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "https://$(cat .droplet_ip 2>/dev/null || echo 'YOUR_SERVER_IP'):443" >> $GITHUB_STEP_SUMMARY
          echo "Username: admin@kasm.local" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â±ï¸ Installation Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Software installation takes 5-15 minutes after server creation.**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Monitor the installation progress:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "ssh root@$(cat .droplet_ip 2>/dev/null || echo 'YOUR_SERVER_IP') tail -f /var/log/kasm-install.log" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Installed Components" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… KASM Workspace (Remote Desktop in Browser)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Docker (Container Runtime)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Node.js 20.x (JavaScript Runtime)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Python 3.x (Python Runtime)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Git (Version Control)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Development Tools" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’° Cost Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Memory-Optimized 32GB Droplet Pricing:**" >> $GITHUB_STEP_SUMMARY
          echo "- Monthly: \$250/month" >> $GITHUB_STEP_SUMMARY
          echo "- Hourly: \$0.347/hour" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ—‘ï¸ Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "When you're finished using the server, delete it to avoid ongoing charges:" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to Actions tab" >> $GITHUB_STEP_SUMMARY
          echo "2. Select 'ðŸ—‘ï¸ Delete Development Server' workflow" >> $GITHUB_STEP_SUMMARY
          echo "3. Click 'Run workflow'" >> $GITHUB_STEP_SUMMARY
          echo "4. Select 'yes' to confirm deletion" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "âœ¨ Your development server is ready! ðŸš€" >> $GITHUB_STEP_SUMMARY
      
      - name: âŒ Failure Report
        if: failure()
        run: |
          echo "## âŒ Server Creation Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Troubleshooting Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**1ï¸âƒ£ Check Secrets Configuration**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Go to: Settings â†’ Secrets and variables â†’ Actions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Verify both secrets exist:" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] DO_API_TOKEN" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] SSH_KEY_NAME" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**2ï¸âƒ£ Verify DigitalOcean API Token**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Your API token should have these permissions:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… read (read account data)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… write (create and manage droplets)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**3ï¸âƒ£ Check SSH Key in DigitalOcean**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Go to: https://cloud.digitalocean.com/account/security" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Verify the SSH key name exactly matches your SSH_KEY_NAME secret (case-sensitive)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**4ï¸âƒ£ Check Account Status**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Billing is active" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] No resource quotas exceeded" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Droplet creation is allowed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**5ï¸âƒ£ Check Workflow Logs**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Click on each failed step above to see detailed error messages." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“š Documentation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For more help, see:" >> $GITHUB_STEP_SUMMARY
          echo "- [Setup Guide](../../blob/main/SETUP.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [Troubleshooting](../../blob/main/TROUBLESHOOTING.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [Diagnostic Guide](../../blob/main/DIAGNOSTIC-GUIDE.md)" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ”” Debug Information
        if: failure()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >&2
          echo "DEBUG INFORMATION" >&2
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >&2
          echo "" >&2
          echo "Workflow Run ID: ${{ github.run_id }}" >&2
          echo "Job ID: ${{ github.job }}" >&2
          echo "Timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >&2
          echo "" >&2
          echo "Environment:" >&2
          echo "- Server Name: ${{ github.event.inputs.server_name }}" >&2
          echo "- Region: ${{ github.event.inputs.region }}" >&2
          echo "- SSH Key Name: ${{ secrets.SSH_KEY_NAME }}" >&2
          echo "" >&2
          echo "Files in repository:" >&2
          ls -la *.sh 2>/dev/null || echo "No shell scripts found" >&2
          echo "" >&2
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >&2
