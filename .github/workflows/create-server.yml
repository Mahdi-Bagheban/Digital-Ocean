# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘         ğŸš€ DigitalOcean Server Creation Workflow v5.2                â•‘
# â•‘                                                                           â•‘
# â•‘  ğŸ“ Purpose:  Ø®ÙˆØ¯Ú©Ø§Ø±â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø±ÙˆØ±â€ŒÙ‡Ø§ÛŒ DigitalOcean       â•‘
# â•‘  ğŸŒŸ Version:  5.2 (Production Ready)                                  â•‘
# â•‘  ğŸ‰ Features:  Validation, Health Check, Cost Estimation          â•‘
# â•‘  ğŸ‘¤ Author:    Mahdi Bagheban                                       â•‘
# â•‘  ğŸ“… Date:      December 2025                                        â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ğŸš€ Create DigitalOcean Server

on:
  workflow_dispatch:
    inputs:
      server_name:
        description: 'ğŸ“ Ù†Ø§Ù… Ø³Ø±ÙˆØ± | Server Name'
        required: true
        default: 'mahdi-dev-workspace'
        type: string

      region:
        description: 'ğŸŒ Ù…Ù†Ø·Ù‚Ù‡ | Region (ğŸš€ fra1 Ø¨Ù‡ØªØ±ÛŒÙ† Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ±Ø§Ù†)'
        required: true
        default: 'fra1'
        type: choice
        options:
          - fra1
          - ams3
          - lon1
          - nyc1
          - sfo3
          - sgp1

      size_slug:
        description: 'ğŸ’ª Ù¾Ù„Ù† Ø³Ø±ÙˆØ± | Server Plan'
        required: true
        default: 'm-8vcpu-64gb'
        type: choice
        options:
          - s-2vcpu-4gb
          - s-4vcpu-8gb
          - m-8vcpu-64gb
          - m-16vcpu-128gb
          - m-24vcpu-192gb
          - m-32vcpu-256gb

      enable_ipv6:
        description: 'ğŸŒ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ IPv6 | Enable IPv6'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

      enable_backups:
        description: 'ğŸ’¾ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù†ÛŒØ±Ø¨Ù‡ | Enable Backups (Extra Cost)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

      custom_tags:
        description: 'ğŸ·ï¸ Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´ÛŒ | Custom Tags (comma-separated)'
        required: false
        default: 'github-actions,development'
        type: string

jobs:
  validate:
    name: âœ… Validate & Prepare
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      ssh_key_id: ${{ steps.get_ssh_key.outputs.ssh_key_id }}
      monthly_cost: ${{ steps.calc_cost.outputs.monthly }}

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: âœ… Validate Secrets
        run: |
          echo "ğŸ” Validating secrets..."
          [ -n "${{ secrets.DO_API_TOKEN }}" ] || { echo "âŒ DO_API_TOKEN missing"; exit 1; }
          [ -n "${{ secrets.SSH_KEY_NAME }}" ] || { echo "âŒ SSH_KEY_NAME missing"; exit 1; }
          echo "âœ… Secrets valid"

      - name: ğŸ”§ Install Tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq curl bc 2>&1 | tail -1

      - name: ğŸ”‘ Get SSH Key ID
        id: get_ssh_key
        run: |
          response=$(curl -s -X GET \
            -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
            "https://api.digitalocean.com/v2/account/keys")
          
          ssh_id=$(echo "$response" | jq -r ".ssh_keys[] | select(.name==\"${{ secrets.SSH_KEY_NAME }}\") | .id")
          
          if [ -z "$ssh_id" ] || [ "$ssh_id" = "null" ]; then
            echo "âŒ SSH Key not found: ${{ secrets.SSH_KEY_NAME }}"
            exit 1
          fi
          
          echo "ssh_key_id=$ssh_id" >> $GITHUB_OUTPUT
          echo "âœ… SSH Key found"

      - name: ğŸ’° Calculate Cost
        id: calc_cost
        run: |
          case "${{ github.event.inputs.size_slug }}" in
            s-2vcpu-4gb) echo "monthly=26" ;;
            s-4vcpu-8gb) echo "monthly=52" ;;
            m-8vcpu-64gb) echo "monthly=435" ;;
            m-16vcpu-128gb) echo "monthly=870" ;;
            m-24vcpu-192gb) echo "monthly=1305" ;;
            m-32vcpu-256gb) echo "monthly=1740" ;;
          esac >> $GITHUB_OUTPUT

  create:
    name: ğŸ—ï¸ Create Server
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      droplet_id: ${{ steps.create.outputs.droplet_id }}
      server_ip: ${{ steps.get_info.outputs.ipv4 }}

    steps:
      - name: ğŸ”¨ Install Tools
        run: sudo apt-get install -y jq curl 2>&1 | tail -1

      - name: ğŸ—ï¸ Create Droplet
        id: create
        timeout-minutes: 3
        run: |
          echo "ğŸ—ï¸ Creating Droplet..."
          
          payload=$(cat <<'EOF'
{
  "name": "${{ github.event.inputs.server_name }}",
  "region": "${{ github.event.inputs.region }}",
  "size": "${{ github.event.inputs.size_slug }}",
  "image": "ubuntu-24-04-x64",
  "ssh_keys": [${{ needs.validate.outputs.ssh_key_id }}],
  "backups": ${{ github.event.inputs.enable_backups }},
  "ipv6": ${{ github.event.inputs.enable_ipv6 }},
  "monitoring": true,
  "tags": ["${{ github.event.inputs.custom_tags }}".split(",")]
}
EOF
          )
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "$payload" \
            "https://api.digitalocean.com/v2/droplets")
          
          http_code=$(echo "$response" | tail -1)
          body=$(echo "$response" | sed '$d')
          
          [ "$http_code" = "201" ] || { echo "âŒ Creation failed"; exit 1; }
          
          droplet_id=$(echo "$body" | jq -r '.droplet.id')
          echo "droplet_id=$droplet_id" >> $GITHUB_OUTPUT
          echo "âœ… Droplet created: $droplet_id"

      - name: â³ Wait for Activation
        timeout-minutes: 12
        run: |
          droplet_id="${{ steps.create.outputs.droplet_id }}"
          echo "â³ Waiting for activation..."
          
          for i in {0..50}; do
            status=$(curl -s -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
              "https://api.digitalocean.com/v2/droplets/$droplet_id" | jq -r '.droplet.status')
            
            [ "$status" = "active" ] && { echo "âœ… Active"; exit 0; }
            printf "\r[%3d%%] Status: %-8s" "$((i*2))" "$status"
            sleep 12
          done
          
          echo "\nâŒ Timeout"
          exit 1

      - name: ğŸ“Š Get Info
        id: get_info
        run: |
          data=$(curl -s -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
            "https://api.digitalocean.com/v2/droplets/${{ steps.create.outputs.droplet_id }}")
          
          ipv4=$(echo "$data" | jq -r '.droplet.networks.v4[] | select(.type=="public") | .ip_address' | head -1)
          echo "ipv4=$ipv4" >> $GITHUB_OUTPUT
          echo "$ipv4" > .droplet_ip
          echo "âœ… IP: $ipv4"

      - name: ğŸ¥ Health Check
        timeout-minutes: 5
        run: |
          ip="${{ steps.get_info.outputs.ipv4 }}"
          for i in {1..10}; do
            timeout 3 bash -c "echo >/dev/tcp/$ip/22" 2>/dev/null && exit 0
            echo "â³ SSH attempt $i/10"
            sleep 3
          done
          echo "âš ï¸ SSH not yet available"

      - name: ğŸ’¾ Save Info
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: server-${{ steps.create.outputs.droplet_id }}
          path: .droplet_ip
          retention-days: 30

  summary:
    name: ğŸ“‹ Summary
    needs: [validate, create]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ğŸŒŸ Success Summary
        if: success()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ğŸ‰ Server Created Successfully!
          
          ## ğŸ“‹ Configuration
          
          | ğŸ’« Parameter | ğŸ“„ Value |
          |---|---|
          | **Server Name** | `${{ github.event.inputs.server_name }}` |
          | **Droplet ID** | `${{ needs.create.outputs.droplet_id }}` |
          | **IP Address** | `${{ needs.create.outputs.server_ip }}` |
          | **Region** | `${{ github.event.inputs.region }}` |
          | **Plan** | `${{ github.event.inputs.size_slug }}` |
          | **Monthly Cost** | `${{ needs.validate.outputs.monthly_cost }}$` |
          | **IPv6** | ${{ github.event.inputs.enable_ipv6 }} |
          | **Backups** | ${{ github.event.inputs.enable_backups }} |
          
          ## ğŸ”— Connection Command
          
          ```bash
          ssh root@${{ needs.create.outputs.server_ip }}
          ```
          
          ## âš ï¸ Important Notes
          
          - â³ Installation takes 5-20 minutes
          - ğŸ”‘ SSH key authentication is configured
          - ğŸ—‘ **Remember to delete the server when done!**
          
          ---
          **âœ¨ Ready to use!**
          EOF

      - name: âŒ Failure Summary
        if: failure()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # âŒ Creation Failed
          
          Please check:
          1. âœ… Secrets are configured
          2. âœ… SSH Key exists in DigitalOcean
          3. âœ… Account has available quota
          4. âœ… Region supports the selected plan
          
          **Check logs above for details.**
          EOF
