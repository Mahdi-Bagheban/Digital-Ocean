name: 'ðŸ—ï¸ Create DigitalOcean Server + RustDesk

on:
  workflow_dispatch:
    inputs:
      server_name:
        description: 'Server Name (e.g., my-rustdesk-server)'
        required: true
        default: 'rustdesk-server'
        type: string

      region:
        description: 'Region (Frankfurt best for Iran)'
        required: true
        default: 'fra1'
        type: choice
        options:
          - 'fra1'
          - 'ams3'
          - 'lon1'
          - 'nyc1'
          - 'sfo3'
          - 'sgp1'

      size_slug:
        description: 'Server Plan (Small recommended)'
        required: true
        default: 's-2vcpu-4gb-intel'
        type: choice
        options:
          - 's-1vcpu-512mb-10gb'
          - 's-2vcpu-4gb-intel'
          - 's-4vcpu-8gb-intel'
          - 'm-2vcpu-16gb'
          - 'm-8vcpu-64gb-intel'

jobs:
  create-server:
    name: Create and Configure Server
    runs-on: ubuntu-latest
    timeout-minutes: 45

    outputs:
      droplet_id: ${{ steps.create_droplet.outputs.droplet_id }}
      server_ip: ${{ steps.get_network.outputs.ipv4 }}
      server_ipv6: ${{ steps.get_network.outputs.ipv6 }}
      server_name: ${{ github.event.inputs.server_name }}

    steps:
      # ========================================
      # PHASE 1: PREPARATION
      # ========================================

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install System Tools
        run: |
          echo "Installing required tools..."
          sudo apt-get update -qq
          sudo apt-get install -y jq curl qrencode bc 2>&1 | tail -2
          echo ""
          echo "Tools installed:"
          echo "  - jq (JSON parser)"
          echo "  - curl (HTTP client)"
          echo "  - qrencode (QR generator)"
          echo "  - bc (calculator)"

      - name: Display Configuration
        run: |
          echo "==========================================="
          echo "SERVER CONFIGURATION"
          echo "==========================================="
          echo ""
          echo "Server Name: ${{ github.event.inputs.server_name }}"
          echo "Region: ${{ github.event.inputs.region }}"
          echo "Plan: ${{ github.event.inputs.size_slug }}"
          echo "OS: Ubuntu 24.04 LTS"
          echo ""
          echo "Will install:"
          echo "  - Docker (container platform)"
          echo "  - Node.js v20 LTS"
          echo "  - Python 3"
          echo "  - RustDesk Server OSS v1.41.9"
          echo "  - UFW Firewall"
          echo "  - Development tools"
          echo ""
          echo "==========================================="

      # ========================================
      # PHASE 2: CREATE DROPLET
      # ========================================

      - name: Create Droplet
        id: create_droplet
        run: |
          echo "Creating droplet on DigitalOcean..."
          
          response=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "name": "${{ github.event.inputs.server_name }}",
              "region": "${{ github.event.inputs.region }}",
              "size": "${{ github.event.inputs.size_slug }}",
              "image": "ubuntu-24-04-x64",
              "ssh_keys": ["MahdiArts"],
              "backups": false,
              "ipv6": true,
              "monitoring": true,
              "tags": ["github-actions", "rustdesk", "v14"]
            }' \
            "https://api.digitalocean.com/v2/droplets")
          
          droplet_id=$(echo "$response" | jq -r '.droplet.id // empty')
          
          if [ -z "$droplet_id" ]; then
            echo "ERROR: Failed to create droplet"
            echo "Response:"
            echo "$response" | jq '.' 2>/dev/null || echo "$response"
            exit 1
          fi
          
          echo "droplet_id=$droplet_id" >> $GITHUB_OUTPUT
          echo ""
          echo "SUCCESS: Droplet created"
          echo "  ID: $droplet_id"
          echo "  Name: ${{ github.event.inputs.server_name }}"

      - name: Wait for Activation
        run: |
          droplet_id="${{ steps.create_droplet.outputs.droplet_id }}"
          echo "Waiting for droplet activation (max 120s)..."
          
          for i in {1..60}; do
            response=$(curl -s -X GET \
              -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
              "https://api.digitalocean.com/v2/droplets/$droplet_id")
            
            status=$(echo "$response" | jq -r '.droplet.status // "unknown"')
            
            if [ "$status" = "active" ]; then
              echo ""
              echo "SUCCESS: Droplet active (${i}x2 = $((i*2)) seconds)"
              exit 0
            fi
            
            if [ $((i % 10)) -eq 0 ]; then
              echo "  [$((i*2))s] Status: $status"
            fi
            
            sleep 2
          done
          
          echo ""
          echo "ERROR: Timeout after 120 seconds"
          exit 1

      # ========================================
      # PHASE 3: NETWORK CONFIGURATION
      # ========================================

      - name: Get Network Information
        id: get_network
        run: |
          droplet_id="${{ steps.create_droplet.outputs.droplet_id }}"
          echo "Retrieving network information..."
          
          response=$(curl -s -X GET \
            -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
            "https://api.digitalocean.com/v2/droplets/$droplet_id")
          
          ipv4=$(echo "$response" | jq -r '.droplet.networks.v4[] | select(.type=="public") | .ip_address' | head -1)
          ipv6=$(echo "$response" | jq -r '.droplet.networks.v6[0].ip_address // "Not Available"')
          
          if [ -z "$ipv4" ]; then
            echo "ERROR: Could not retrieve IPv4"
            exit 1
          fi
          
          echo "ipv4=$ipv4" >> $GITHUB_OUTPUT
          echo "ipv6=$ipv6" >> $GITHUB_OUTPUT
          
          echo ""
          echo "Network info:"
          echo "  IPv4: $ipv4"
          echo "  IPv6: $ipv6"

      - name: Configure SSH
        run: |
          echo "Configuring SSH access..."
          
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          if grep -q "BEGIN" ~/.ssh/id_rsa; then
            echo ""
            echo "SUCCESS: SSH key configured"
          else
            echo ""
            echo "ERROR: Invalid SSH key"
            exit 1
          fi

      - name: Wait for SSH
        run: |
          ip="${{ steps.get_network.outputs.ipv4 }}"
          echo "Waiting for SSH service (max 120s)..."
          
          for i in {1..60}; do
            if timeout 3 bash -c "echo > /dev/tcp/$ip/22" 2>/dev/null; then
              echo ""
              echo "SUCCESS: SSH ready"
              sleep 2
              exit 0
            fi
            
            if [ $((i % 10)) -eq 0 ]; then
              echo "  [$((i*2))s] Waiting..."
            fi
            
            sleep 2
          done
          
          echo ""
          echo "WARNING: SSH check timeout (continuing anyway)"

      - name: Test SSH Connection
        run: |
          ip="${{ steps.get_network.outputs.ipv4 }}"
          echo "Testing SSH connection..."
          
          if ssh -o StrictHostKeyChecking=accept-new \
                 -o UserKnownHostsFile=/dev/null \
                 -o ConnectTimeout=10 \
                 -o LogLevel=ERROR \
                 -i ~/.ssh/id_rsa \
                 root@$ip \
                 'echo "Connection successful" && uname -a'; then
            echo ""
            echo "SUCCESS: SSH working"
          else
            echo ""
            echo "ERROR: SSH failed"
            exit 1
          fi

      # ========================================
      # PHASE 4: SERVER INITIALIZATION
      # ========================================

      - name: Initialize Server
        run: |
          cat > /tmp/init.sh << 'SETUP_SCRIPT'
          #!/bin/bash
          set -e
          
          echo "==========================================="
          echo "SERVER INITIALIZATION v14.0"
          echo "==========================================="
          echo ""
          
          # Update system
          echo "[1/8] Updating system..."
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update -qq
          sudo apt-get upgrade -y -qq
          sudo apt-get install -y curl wget git build-essential 2>&1 | tail -1
          echo "      Done"
          
          # Docker
          echo "[2/8] Installing Docker..."
          curl -fsSL https://get.docker.com -o /tmp/docker.sh
          sudo sh /tmp/docker.sh > /dev/null 2>&1
          sudo usermod -aG docker root
          sudo systemctl start docker
          sudo systemctl enable docker
          echo "      Done: $(docker --version | cut -d' ' -f3 | tr -d ',')"
          
          # Node.js
          echo "[3/8] Installing Node.js..."
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash - > /dev/null 2>&1
          sudo apt-get install -y nodejs
          echo "      Done: $(node -v)"
          
          # Python
          echo "[4/8] Installing Python..."
          sudo apt-get install -y python3 python3-pip python3-dev python3-venv
          echo "      Done: $(python3 --version | cut -d' ' -f2)"
          
          # Dev tools
          echo "[5/8] Installing dev tools..."
          sudo apt-get install -y git nano vim htop jq
          echo "      Done"
          
          # Firewall
          echo "[6/8] Configuring firewall..."
          sudo apt-get install -y ufw
          sudo ufw --force reset > /dev/null
          sudo ufw default deny incoming
          sudo ufw default allow outgoing
          sudo ufw allow 22/tcp
          sudo ufw allow 80/tcp
          sudo ufw allow 443/tcp
          sudo ufw allow 5900:5901/tcp
          sudo ufw allow 21115:21119/tcp
          sudo ufw --force enable
          echo "      Done: 5 rules configured"
          
          # RustDesk
          echo "[7/8] Installing RustDesk..."
          sudo mkdir -p /opt/rustdesk
          cd /opt/rustdesk
          wget -q https://github.com/rustdesk/rustdesk-server/releases/download/1.41.9/rustdesk-server-linux-x64.zip
          unzip -q rustdesk-server-linux-x64.zip
          rm rustdesk-server-linux-x64.zip
          sudo chmod +x hbbr hbbs
          echo "      Done: v1.41.9"
          
          # Services
          echo "[8/8] Starting services..."
          
          sudo tee /etc/systemd/system/rustdesk-hbbs.service > /dev/null << 'SRV1'
          [Unit]
          Description=RustDesk Signal Server
          After=network.target
          
          [Service]
          Type=simple
          User=root
          WorkingDirectory=/opt/rustdesk
          ExecStart=/opt/rustdesk/hbbs
          Restart=always
          RestartSec=5
          
          [Install]
          WantedBy=multi-user.target
          SRV1
          
          sudo tee /etc/systemd/system/rustdesk-hbbr.service > /dev/null << 'SRV2'
          [Unit]
          Description=RustDesk Relay Server
          After=network.target rustdesk-hbbs.service
          
          [Service]
          Type=simple
          User=root
          WorkingDirectory=/opt/rustdesk
          ExecStart=/opt/rustdesk/hbbr
          Restart=always
          RestartSec=5
          
          [Install]
          WantedBy=multi-user.target
          SRV2
          
          sudo systemctl daemon-reload
          sudo systemctl enable rustdesk-hbbs rustdesk-hbbr
          sudo systemctl start rustdesk-hbbs rustdesk-hbbr
          sleep 2
          
          if sudo systemctl is-active rustdesk-hbbs > /dev/null; then
            echo "      Done: Services active"
          else
            echo "      Done: Services starting..."
          fi
          
          echo ""
          echo "==========================================="
          echo "INITIALIZATION COMPLETE"
          echo "==========================================="
          echo ""
          echo "Installed:"
          echo "  - Ubuntu 24.04 LTS"
          echo "  - Docker"
          echo "  - Node.js v20"
          echo "  - Python 3"
          echo "  - RustDesk Server v1.41.9"
          echo "  - UFW Firewall"
          echo ""
          echo "Server ready for RustDesk connections!"
          SETUP_SCRIPT
          
          chmod +x /tmp/init.sh
          
          echo "Executing initialization script..."
          echo "This takes 5-10 minutes..."
          echo ""
          
          ssh -o StrictHostKeyChecking=accept-new \
              -o UserKnownHostsFile=/dev/null \
              -o LogLevel=ERROR \
              -i ~/.ssh/id_rsa \
              root@${{ steps.get_network.outputs.ipv4 }} \
              'bash -s' < /tmp/init.sh
          
          echo ""
          echo "SUCCESS: Server initialized"

      # ========================================
      # PHASE 5: DOCUMENTATION
      # ========================================

      - name: Extract RustDesk Key
        id: rustdesk
        run: |
          ip="${{ steps.get_network.outputs.ipv4 }}"
          echo "Extracting RustDesk key (max 15 attempts)..."
          
          key=""
          for i in {1..15}; do
            key=$(ssh -o StrictHostKeyChecking=accept-new \
                      -o UserKnownHostsFile=/dev/null \
                      -o LogLevel=ERROR \
                      -i ~/.ssh/id_rsa \
                      root@$ip \
                      'cat /opt/rustdesk/id_ed25519.pub 2>/dev/null' || true)
            
            if [ -n "$key" ]; then
              echo "SUCCESS: Key extracted (attempt $i)"
              break
            fi
            
            if [ $((i % 5)) -eq 0 ]; then
              echo "  Attempt $i/15"
            fi
            sleep 2
          done
          
          if [ -z "$key" ]; then
            key="Key will generate on first connection"
          fi
          
          echo "rustdesk_key=$key" >> $GITHUB_OUTPUT

      - name: Generate Guide
        run: |
          mkdir -p /tmp/assets
          
          cat > /tmp/assets/GUIDE.md << 'DOC'
          # RustDesk Server - Quick Start
          
          ## Server Info
          
          - Name: SERVER_NAME
          - IPv4: SERVER_IP
          - IPv6: SERVER_IPV6
          - Region: SERVER_REGION
          
          ## Connect (3 Steps)
          
          1. Download RustDesk: https://rustdesk.com
          2. Enter IP: SERVER_IP
          3. Click Connect
          
          ## What's Installed
          
          - Ubuntu 24.04 LTS
          - Docker
          - Node.js v20 LTS
          - Python 3
          - RustDesk Server v1.41.9
          - UFW Firewall
          
          ## SSH Access
          
          ```bash
          ssh root@SERVER_IP
          ```
          
          ## Delete Server
          
          Run: "Delete DigitalOcean Server" workflow
          Enter: SERVER_NAME
          
          ## Support
          
          - RustDesk: https://rustdesk.com/docs/
          - GitHub: https://github.com/Mahdi-Bagheban/Digital-Ocean
          DOC
          
          sed -i "s/SERVER_NAME/${{ github.event.inputs.server_name }}/g" /tmp/assets/GUIDE.md
          sed -i "s/SERVER_IP/${{ steps.get_network.outputs.ipv4 }}/g" /tmp/assets/GUIDE.md
          sed -i "s/SERVER_IPV6/${{ steps.get_network.outputs.ipv6 }}/g" /tmp/assets/GUIDE.md
          sed -i "s/SERVER_REGION/${{ github.event.inputs.region }}/g" /tmp/assets/GUIDE.md
          
          echo "Guide generated"

      - name: Generate QR Code
        run: |
          qrencode -o /tmp/assets/QR.png "${{ steps.get_network.outputs.ipv4 }}" -s 10 -m 2
          echo "QR code generated"

      # ========================================
      # PHASE 6: RELEASE
      # ========================================

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v14.0-${{ steps.create_droplet.outputs.droplet_id }}-${{ github.run_id }}
          name: Server ${{ github.event.inputs.server_name }} (ID ${{ steps.create_droplet.outputs.droplet_id }})
          body: |
            # Server Ready!
            
            **IPv4:** `${{ steps.get_network.outputs.ipv4 }}`  
            **IPv6:** `${{ steps.get_network.outputs.ipv6 }}`  
            **Region:** ${{ github.event.inputs.region }}
            
            ## Quick Start
            1. Download: https://rustdesk.com
            2. IP: `${{ steps.get_network.outputs.ipv4 }}`
            3. Connect
            
            ## Installed
            - Ubuntu 24.04 LTS
            - Docker + Node.js + Python
            - RustDesk Server v1.41.9
            - UFW Firewall
            
            See GUIDE.md and QR.png in assets below.
          files: |
            /tmp/assets/GUIDE.md
            /tmp/assets/QR.png
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ========================================
      # PHASE 7: SUMMARY
      # ========================================

      - name: Job Summary
        if: success()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'END'
          # Server Created Successfully!
          
          ## Details
          
          | Field | Value |
          |-------|-------|
          | Name | ${{ github.event.inputs.server_name }} |
          | ID | ${{ steps.create_droplet.outputs.droplet_id }} |
          | IPv4 | `${{ steps.get_network.outputs.ipv4 }}` |
          | IPv6 | `${{ steps.get_network.outputs.ipv6 }}` |
          | Region | ${{ github.event.inputs.region }} |
          
          ## Connect Now
          
          1. Download: https://rustdesk.com
          2. IP: `${{ steps.get_network.outputs.ipv4 }}`
          3. Connect
          
          ## SSH Access
          
          ```bash
          ssh root@${{ steps.get_network.outputs.ipv4 }}
          ```
          
          ## Delete When Done
          
          Actions â†’ Delete DigitalOcean Server
          
          ---
          
          Status: OPERATIONAL | Version: v14.0
          END

      - name: Error Summary
        if: failure()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'END'
          # Creation Failed
          
          ## Check
          
          1. Secrets: DO_API_TOKEN, SSH_PRIVATE_KEY
          2. DigitalOcean: Credit, SSH key "MahdiArts"
          3. Logs: Review errors above
          4. Dashboard: Delete partial droplets
          
          ## Help
          
          - ERROR_ANALYSIS.md in repository
          - GitHub Issues
          END
