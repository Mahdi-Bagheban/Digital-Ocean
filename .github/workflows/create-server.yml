name: ðŸš€ Create Development Server

on:
  workflow_dispatch:
    inputs:
      server_name:
        description: 'ðŸ“ Server Name (Ù†Ø§Ù… Ø³Ø±ÙˆØ±)'
        required: true
        default: 'dev-server'
        type: string
      region:
        description: 'ðŸŒ Region (Ù…Ù†Ø·Ù‚Ù‡)'
        required: true
        default: 'fra1'
        type: choice
        options:
          - 'fra1'  # Frankfurt
          - 'ams3'  # Amsterdam
          - 'lon1'  # London
          - 'nyc1'  # New York
          - 'sgp1'  # Singapore

jobs:
  create-server:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
          echo "âœ… Dependencies installed"
      
      - name: ðŸ” Validate Secrets
        run: |
          if [ -z "${{ secrets.DO_API_TOKEN }}" ]; then
            echo "âŒ DO_API_TOKEN secret not found!"
            exit 1
          fi
          
          if [ -z "${{ secrets.SSH_KEY_NAME }}" ]; then
            echo "âŒ SSH_KEY_NAME secret not found!"
            exit 1
          fi
          
          echo "âœ… All secrets validated"
      
      - name: ðŸ”‘ Get SSH Key ID
        id: ssh_key
        run: |
          echo "ðŸ” Searching for SSH key: ${{ secrets.SSH_KEY_NAME }}"
          
          response=$(curl -s -X GET \
            -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            "https://api.digitalocean.com/v2/account/keys")
          
          ssh_key_id=$(echo "$response" | jq -r ".ssh_keys[] | select(.name==\"${{ secrets.SSH_KEY_NAME }}\") | .id")
          
          if [ -z "$ssh_key_id" ] || [ "$ssh_key_id" = "null" ]; then
            echo "âŒ SSH Key '${{ secrets.SSH_KEY_NAME }}' not found!"
            echo "Available keys:"
            echo "$response" | jq -r '.ssh_keys[] | "  - \(.name)"'
            exit 1
          fi
          
          echo "âœ… Found SSH Key ID: $ssh_key_id"
          echo "ssh_key_id=$ssh_key_id" >> $GITHUB_OUTPUT
      
      - name: ðŸ—ï¸ Create Droplet
        id: create_droplet
        run: |
          echo "## ðŸ—ï¸ Creating Server" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Create droplet using API
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "name": "${{ github.event.inputs.server_name }}",
              "region": "${{ github.event.inputs.region }}",
              "size": "s-2vcpu-4gb",
              "image": "ubuntu-22-04-x64",
              "ssh_keys": [${{ steps.ssh_key.outputs.ssh_key_id }}],
              "backups": false,
              "ipv6": true,
              "monitoring": true,
              "tags": ["development", "github-actions"]
            }' \
            "https://api.digitalocean.com/v2/droplets")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          if [ "$http_code" != "202" ]; then
            echo "âŒ API request failed with HTTP $http_code"
            echo "$body" | jq '.'
            echo "**Status:** âŒ Failed (HTTP $http_code)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          droplet_id=$(echo "$body" | jq -r '.droplet.id')
          echo "droplet_id=$droplet_id" >> $GITHUB_OUTPUT
          
          echo "âœ… Droplet created with ID: $droplet_id"
          echo "**Droplet ID:** \`$droplet_id\`" >> $GITHUB_STEP_SUMMARY
      
      - name: â³ Wait for Server Activation
        id: wait_active
        run: |
          droplet_id=${{ steps.create_droplet.outputs.droplet_id }}
          max_attempts=60
          attempt=0
          status=""
          
          echo "â³ Waiting for droplet to become active..."
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â³ Activation Progress" >> $GITHUB_STEP_SUMMARY
          
          while [ "$status" != "active" ] && [ $attempt -lt $max_attempts ]; do
            sleep 10
            attempt=$((attempt + 1))
            
            response=$(curl -s -X GET \
              -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
              "https://api.digitalocean.com/v2/droplets/$droplet_id")
            
            status=$(echo "$response" | jq -r '.droplet.status')
            progress=$((attempt * 100 / max_attempts))
            
            echo "[â³] Status: $status | Progress: ${progress}% | Attempt: ${attempt}/${max_attempts}"
          done
          
          if [ "$status" != "active" ]; then
            echo "âŒ Droplet failed to activate within timeout"
            echo "**Status:** âŒ Activation timeout" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "âœ… Droplet is now active!"
          echo "**Status:** âœ… Active (took ${attempt}0 seconds)" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ“Š Get Server Information
        id: server_info
        run: |
          droplet_id=${{ steps.create_droplet.outputs.droplet_id }}
          
          response=$(curl -s -X GET \
            -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
            "https://api.digitalocean.com/v2/droplets/$droplet_id")
          
          ipv4=$(echo "$response" | jq -r '.droplet.networks.v4[] | select(.type=="public") | .ip_address')
          ipv6=$(echo "$response" | jq -r '.droplet.networks.v6[] | select(.type=="public") | .ip_address')
          region=$(echo "$response" | jq -r '.droplet.region.name')
          
          echo "ipv4=$ipv4" >> $GITHUB_OUTPUT
          echo "ipv6=$ipv6" >> $GITHUB_OUTPUT
          echo "region=$region" >> $GITHUB_OUTPUT
          
          # Save to file for artifact
          echo "$droplet_id" > .droplet_id
          echo "$ipv4" > .droplet_ip
          echo "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" > .droplet_created_at
          
          echo "âœ… Server information collected"
      
      - name: ðŸ’¾ Save Server Information
        uses: actions/upload-artifact@v4
        with:
          name: server-info
          path: |
            .droplet_id
            .droplet_ip
            .droplet_created_at
          retention-days: 30
      
      - name: ðŸ“‹ Success Summary
        if: success()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ## ðŸŽ‰ Ø³Ø±ÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯!
          
          ### ðŸ“‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³Ø±ÙˆØ±
          
          | Ù…ÙˆØ±Ø¯ | Ù…Ù‚Ø¯Ø§Ø± |
          |------|-------|
          | **ðŸ†” Server ID** | `${{ steps.create_droplet.outputs.droplet_id }}` |
          | **ðŸ“ Server Name** | `${{ github.event.inputs.server_name }}` |
          | **ðŸŒ IPv4** | `${{ steps.server_info.outputs.ipv4 }}` |
          | **ðŸŒ IPv6** | `${{ steps.server_info.outputs.ipv6 }}` |
          | **ðŸŒ Region** | `${{ steps.server_info.outputs.region }}` |
          | **ðŸ’» Size** | 2 vCPU, 4GB RAM |
          
          ### ðŸ”— Ø¯Ø³ØªÙˆØ±Ø§Øª Ø§ØªØµØ§Ù„
          
          **SSH Connection:**
          ```bash
          ssh root@${{ steps.server_info.outputs.ipv4 }}
          ```
          
          ### âš ï¸ Ù†Ú©Ø§Øª Ù…Ù‡Ù…
          
          - ðŸ’° Ù‡Ø²ÛŒÙ†Ù‡ Ø³Ø±ÙˆØ±: $24/month ($0.036/hour)
          - ðŸ—‘ï¸ Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù Ø³Ø±ÙˆØ± Ø§Ø² workflow "Delete Development Server" Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
          - ðŸ” Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³Ø±ÙˆØ± Ø¯Ø± Artifacts Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª
          - â±ï¸ Ø³Ø±ÙˆØ± Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø³Øª - Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø±Ù‡Ø§ Ø¯Ø± Ù†Ø³Ø®Ù‡ Ø¨Ø¹Ø¯ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
          
          ### ðŸŽ¯ Ù…Ø±Ø§Ø­Ù„ Ø¨Ø¹Ø¯ÛŒ
          
          1. Ø§Ø² Ø·Ø±ÛŒÙ‚ SSH Ø¨Ù‡ Ø³Ø±ÙˆØ± Ù…ØªØµÙ„ Ø´ÙˆÛŒØ¯
          2. Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø±Ù‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø±Ø§ Ù†ØµØ¨ Ú©Ù†ÛŒØ¯
          3. Ù¾Ø±ÙˆÚ˜Ù‡ Ø®ÙˆØ¯ Ø±Ø§ deploy Ú©Ù†ÛŒØ¯
          
          ---
          
          **âœ¨ Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÛŒÙ… - Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´ÛŒØ¯!**
          EOF
